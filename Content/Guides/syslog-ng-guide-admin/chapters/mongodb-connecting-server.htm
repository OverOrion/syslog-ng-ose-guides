
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd"><body name="mongodb-connecting-server" oldrole="procedure">
<h1 name="mongodb-connecting-server">How &abbrev; connects the MongoDB server</h1>
<p oldrole="para">When &abbrev; connects the MongoDB server during startup, it completes the following steps.</p>
<ol oldrole="procedure"><li oldrole="step">
<p oldrole="para">The &abbrev; application connects the first address listed in the <span class="Code" oldrole="parameter">servers()</span> option.</p>
</li><li oldrole="step">
<ul oldrole="itemizedlist">
<li oldrole="listitem">
<p oldrole="para">If the server is accessible and it is a master MongoDB server, &abbrev; authenticates on the server (if needed), then starts sending the log messages to the server.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">If the server is not accessible, or it is not a master server in a MongoDB replicaset and it does not send the address of the master server, &abbrev; connects the next address listed in the <span class="Code" oldrole="parameter">servers()</span> option.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">If the server is not a master server in a MongoDB replicaset, but it sends the address of the master server, &abbrev; connects the received address.</p>
<MadCap:keyword term="mongodb:['replicasets']"></MadCap:keyword>
<MadCap:keyword term="mongodb:['failover']"></MadCap:keyword>
<MadCap:keyword term="failover:['in mongodb']"></MadCap:keyword>
</li>
</ul>
</li><li oldrole="step">
<p oldrole="para">When &abbrev; connects the master MongoDB server, it retrieves the list of replicas (from the <span class="Code" oldrole="userinput">replSet</span> option of the server), and appends this list to the <span class="Code" oldrole="parameter">servers()</span> option.</p>
<table cellspacing="0" class="TableStyle-NoteTable_Yellow_DoNotEdit" oldrole="warning" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/NoteTable_Yellow_DoNotEdit.css');"><col class="TableStyle-NoteTable_Yellow_DoNotEdit-Column-Column1" style="width: 0.3in;"></col><col class="TableStyle-NoteTable_Yellow_DoNotEdit-Column-Column2"></col><tbody><tr class="TableStyle-NoteTable_Yellow_DoNotEdit-Body-Body1"><td class="TableStyle-NoteTable_Yellow_DoNotEdit-BodyB-Column1-Body1"><p><img src="../../../Resources/Images/Common/caution.png"/></p></td><td class="TableStyle-NoteTable_Yellow_DoNotEdit-BodyA-Column2-Body1"><span class="Yellow">Caution: </span><ul oldrole="itemizedlist">
<li oldrole="listitem">
<p oldrole="para">This means that &abbrev; can send log messages to addresses that are not listed in its configuration.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">Make sure to include the address of your master server in your &abbrev; configuration file, otherwise you risk losing log messages if all the addresses listed in the &abbrev; configuration are offline.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">Addresses retrieved from the MongoDB servers are not stored, and can be lost when &abbrev; is restarted. The retrieved addresses are not lost if the <span class="Code" oldrole="parameter">server()</span> option of the destination was not changed in the configuration file since the last restart.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">The failover mechanism used in the <span class="Code" oldrole="parameter">mongodb()</span> driver is different from the client-side failover used in other drivers.</p>
</li>
</ul></td></tr></tbody></table>
</li><li oldrole="step">
<p oldrole="para">The &abbrev; application attempts to connect another server if the <span class="Code" oldrole="parameter">servers()</span> list contains at least two addresses, and one of the following events happens:</p>
<ul oldrole="itemizedlist">
<li oldrole="listitem">
<p oldrole="para">The <span class="Code" oldrole="userinput">safe-mode()</span> option is set to <span class="Code" oldrole="userinput">no</span>, and the MongoDB server becomes unreachable.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">The <span class="Code" oldrole="userinput">safe-mode()</span> option is set to <span class="Code" oldrole="userinput">yes</span>, and &abbrev; cannot insert a log message into the database because of an error.</p>
</li>
</ul>
<p oldrole="para">In such case, &abbrev; starts to connect the addresses in from the <span class="Code" oldrole="parameter">servers()</span> list (starting from the first address) to find the new master server, authenticates on the new server (if needed), then continues to send the log messages to the new master server.</p>
<p oldrole="para">During this failover step, one message can be lost if the <span class="Code" oldrole="parameter">safe-mode()</span> option is disabled.</p>
</li><li oldrole="step">
<p oldrole="para">If the original master becomes accessible again, &abbrev; will automatically connect to the original master.</p>
</li></ol></body></html>
