<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head>
    </head>
    <body name="geoip2-parser" oldrole="section">
        <h1 name="geoip2-parser">Looking up GeoIP2 data from IP addresses</h1>
        <MadCap:keyword term="geoip2">
        </MadCap:keyword>
        <MadCap:keyword term="parsers:['geoip2']">
        </MadCap:keyword>
        <p oldrole="para">The <MadCap:variable name="General.abbrev"></MadCap:variable> application can lookup IP addresses from an offline GeoIP2 database, and make the retrieved data available in name-value pairs. Depending on the database used, you can access country code, longitude, and latitude information and so on.</p>
        <p oldrole="para">The <MadCap:variable name="General.abbrev"></MadCap:variable> application works with the Country and the City version of the GeoIP2 database, both free and the commercial editions. The <MadCap:variable name="General.abbrev"></MadCap:variable> application works with the <span class="Code" oldrole="filename">mmdb</span> (GeoIP2) format of these databases. Other formats, like <span class="Code" oldrole="filename">csv</span> are not supported.</p>
        <table cellspacing="0" class="TableStyle-NoteTable_Blue_DoNotEdit" oldrole="note" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/NoteTable_Blue_DoNotEdit.css');">
            <col class="TableStyle-NoteTable_Blue_DoNotEdit-Column-Column1" style="width: 0.3in;">
            </col>
            <col class="TableStyle-NoteTable_Blue_DoNotEdit-Column-Column2">
            </col>
            <tbody>
                <tr class="TableStyle-NoteTable_Blue_DoNotEdit-Body-Body1">
                    <td class="TableStyle-NoteTable_Blue_DoNotEdit-BodyB-Column1-Body1">
                        <p>
                            <img src="../../../Resources/Images/Common/note.png" />
                        </p>
                    </td>
                    <td class="TableStyle-NoteTable_Blue_DoNotEdit-BodyA-Column2-Body1"><span class="AllNoteStyles">NOTE: </span>
                        <p oldrole="para">To access longitude and latitude information, download the City version of the <a href="https://www.maxmind.com/en/geoip2-databases">GeoIP2</a> database.</p>
                        <p oldrole="para">There are two types of GeoIP2 databases available.</p>
                        <ul oldrole="itemizedlist">
                            <li oldrole="listitem">
                                <p oldrole="para"><i oldrole="emphasis">GeoLite2 City:</i>
                                </p>
                                <ul oldrole="itemizedlist">
                                    <li oldrole="listitem">
                                        <p oldrole="para">free of charge</p>
                                    </li>
                                    <li oldrole="listitem">
                                        <p oldrole="para">less accurate</p>
                                    </li>
                                </ul>
                            </li>
                            <li oldrole="listitem">
                                <p oldrole="para"><i oldrole="emphasis">GeoIP2 City:</i>
                                </p>
                                <ul oldrole="itemizedlist">
                                    <li oldrole="listitem">
                                        <p oldrole="para">has to be purchased</p>
                                    </li>
                                    <li oldrole="listitem">
                                        <p oldrole="para">more accurate</p>
                                    </li>
                                </ul>
                            </li>
                        </ul>
                        <p oldrole="para">Unzip the downloaded database (for example, to the <span class="Code" oldrole="filename">/usr/share/GeoIP2/GeoIP2City.mmdb</span> file). This path will be used later in the configuration.</p>
                    </td>
                </tr>
            </tbody>
        </table>
        <h2>Referring to parts of the message as a macro</h2>
        <p oldrole="para">You can refer to the separated parts of the message using the key of the value as a macro. For example, if the message contains <span class="Code" oldrole="userinput">KEY1=value1,KEY2=value2</span>, you can refer to the values as <span class="Code" oldrole="userinput">${KEY1}</span> and <span class="Code" oldrole="userinput">${KEY2}</span>.</p>
        <p oldrole="para">For example if the default prefix (<span class="Code" oldrole="userinput">.geoip2</span>) is used, you can determine the country code using <b oldrole="command">${.geoip2.country.iso_code}</b>.</p>
        <p oldrole="para">To look up all keys:</p>
        <ol oldrole="orderedlist">
            <li oldrole="listitem">
                <p oldrole="para">Install the <b oldrole="command">mmdb-bin</b> package.</p>
                <p oldrole="para">After installing this package, you will be able to use the <b oldrole="command">mmdblookup</b> command.</p>
                <table cellspacing="0" class="TableStyle-NoteTable_Blue_DoNotEdit" oldrole="note" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/NoteTable_Blue_DoNotEdit.css');">
                    <col class="TableStyle-NoteTable_Blue_DoNotEdit-Column-Column1" style="width: 0.3in;">
                    </col>
                    <col class="TableStyle-NoteTable_Blue_DoNotEdit-Column-Column2">
                    </col>
                    <tbody>
                        <tr class="TableStyle-NoteTable_Blue_DoNotEdit-Body-Body1">
                            <td class="TableStyle-NoteTable_Blue_DoNotEdit-BodyB-Column1-Body1">
                                <p>
                                    <img src="../../../Resources/Images/Common/note.png" />
                                </p>
                            </td>
                            <td class="TableStyle-NoteTable_Blue_DoNotEdit-BodyA-Column2-Body1"><span class="AllNoteStyles">NOTE: </span>
                                <p oldrole="para">The name of the package depends on the Linux distribution. The package mentioned in this example is on Ubuntu.</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </li>
            <li oldrole="listitem">
                <p oldrole="para">Create a dump using the following command: <b oldrole="command">mmdblookup --file GeoLite2-City.mmdb --ip &lt;your-IP-address&gt;</b></p>
                <p oldrole="para">The resulting dump file will contain the keys that you can use.</p>
            </li>
        </ol>
        <p oldrole="para">For a more complete list of keys, you can also check the <a href="https://dev.maxmind.com/geoip/geoip2/geoip2-city-country-csv-databases/">GeoIP2 City and Country CSV Databases</a>. However, note that the <MadCap:variable name="General.abbrev"></MadCap:variable> application works with the <span class="Code" oldrole="filename">mmdb</span> (GeoIP2) format of these databases. Other formats, like <span class="Code" oldrole="filename">csv</span> are not supported.</p>
        <h2>Using the GeoIP2 parser</h2>
        <h6 oldrole="formalpara">Declaration:</h6><pre class="Code" oldrole="synopsis">parser parser_name {
    geoip2(
        &lt;macro-containing-the-IP-address-to-lookup&gt;
        prefix()
        database("&lt;path-to-geoip2-database-file&gt;")
    );
};</pre>
        <p oldrole="para">In the following example, <MadCap:variable name="General.abbrev"></MadCap:variable> retrieves the GeoIP2 data of the IP address contained in the ${HOST} field of the incoming message (assuming that in this case the ${HOST} field contains an IP address), and includes the data (prefixed with the <span class="Code" oldrole="userinput">geoip2</span> string) in the output JSON message.</p><pre class="Code" oldrole="synopsis">@version: <MadCap:variable name="Version.techversion"></MadCap:variable>
@module geoip2

options {
    keep_hostname(yes);
};

source s_file {
    file("/tmp/input");
};

parser p_geoip2 { geoip2( "${HOST}", prefix( "geoip2." ) database( "/usr/share/GeoIP2/GeoLiteCity.dat" ) ); };

destination d_file {
    file( "/tmp/output" flags(syslog-protocol) template("$(format-json --scope core --key geoip2*)\n") );
};


log {
    source(s_file);
    parser(p_geoip2);
    destination(d_file);
};</pre>
        <p oldrole="para">For example, for the <span class="Code" oldrole="userinput">&lt;38&gt;2017-05-24T13:09:46 192.168.1.1 prg00000[1234]: test message</span> message the output will look like:</p><pre class="Code" oldrole="synopsis">&lt;38&gt;1 2017-05-24T13:09:46+02:00 192.168.1.1 prg00000 1234 - [meta sequenceId="3"] {"geoip2":{"subdivisions":{"0":{"names":{"en":"Budapest"},"iso_code":"BU","geoname_id":"3054638"}},"registered_country":{"names":{"en":"Hungary"},"iso_code":"HU","geoname_id":"719819"},"postal":{"code":"1063"},"location":{"time_zone":"Europe/Budapest","longitude":"19.070200","latitude":"47.510200","accuracy_radius":"5"},"country":{"names":{"en":"Hungary"},"iso_code":"HU","geoname_id":"719819"},"continent":{"names":{"en":"Europe"},"geoname_id":"6255148","code":"EU"},"city":{"names":{"en":"Budapest"},"geoname_id":"3054643"}},"PROGRAM":"prg00000","PRIORITY":"info","PID":"1234","MESSAGE":"test message","HOST":"192.168.1.1","FACILITY":"auth","DATE":"May 24 13:09:46"}</pre>
        <h2>Transferring your logs to Elasticsearch using GeoIP2</h2>
        <p oldrole="para">If you are transferring your log messages into Elasticsearch, use the following rewrite rule to combine the longitude and latitude information into a single value (called <span class="Code" oldrole="userinput">geoip2.location</span>), and set the mapping in Elasticsearch accordingly. Do not forget to include the rewrite in your log path. These examples assume that you used <span class="Code" oldrole="userinput">prefix("geoip2.")</span> instead of the default for the <span class="Code" oldrole="parameter">geoip2</span> parser. For details on transferring your log messages to Elasticsearch, see <MadCap:xref href="configuring-destinations-elasticsearch2.htm#configuring-destinations-elasticsearch2"></MadCap:xref>.</p>
        <MadCap:keyword term="geoip2:['elasticsearch']">
        </MadCap:keyword>
        <MadCap:keyword term="elasticsearch:['transferring geoip2 data']">
        </MadCap:keyword><pre class="Code" oldrole="synopsis">rewrite r_geoip2 {
    set(
        "${geoip2.location.latitude},${geoip2.location.longitude}",
        value( "geoip2.location2" ),
        condition(not "${geoip2.location.latitude}" == "")
    );
};</pre>
        <p oldrole="para">In your Elasticsearch configuration, set the appropriate mappings:</p><pre class="Code" oldrole="synopsis">{
   "mappings" : {
      "_default_" : {
         "properties" : {
            "geoip2" : {
               "properties" : {
                  "location2" : {
                     "type" : "geo_point"
                  }
               }
            }
         }
      }
   }
}</pre>
        <h2 name="geoip2-parser-options">Options of <span class="Code" oldrole="userinput">geoip2</span> parsers</h2>
        <MadCap:keyword term="geoip2">
        </MadCap:keyword>
        <MadCap:keyword term="parsers:['geoip2']">
        </MadCap:keyword>
        <p oldrole="para">The <span class="Code" oldrole="parameter">geoip2</span> parser has the following options.</p>
        <MadCap:snippetBlock src="../../shared/chunk/option-parser-prefix.htm">
        </MadCap:snippetBlock>
        <MadCap:snippetBlock src="../../shared/chunk/para-macro-prefix-parser.htm">
        </MadCap:snippetBlock>
        <p oldrole="para">For example, to insert the <span class="Code" oldrole="userinput">.geoip2</span> prefix, use the <span class="Code" oldrole="userinput">prefix(.geoip2)</span> option. To refer to a particular data when using a prefix, use the prefix in the name of the macro, for example, <b oldrole="command">${geoip2.country_code}</b> .</p>
        <h6 name="geoip2-parser-database" oldrole="simplesect">database()</h6>
        <MadCap:keyword term="database()">
        </MadCap:keyword>
        <table cellspacing="0" class="RuledTableWithHeading_DoNotEdit" colsep="0" frame="topbot" rowsep="0" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/RuledTableWithHeading_DoNotEdit.css');">
            <tbody>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Synopsis:

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">database()</td>
                </tr>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Default:

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    </td>
                </tr>
            </tbody>
            <col class="TableStyle-RuledTableWithHeading_DoNotEdit-Column-Column1" style="width: 0.3in;">
            </col>
        </table>
        <p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> Path to the GeoIP2 database to use. This works with absolute and relative paths as well. Note that <MadCap:variable name="General.abbrev"></MadCap:variable> must have the required privileges to read this file. Do not modify or delete this file while <MadCap:variable name="General.abbrev"></MadCap:variable> is running, it can crash <MadCap:variable name="General.abbrev"></MadCap:variable>.</p>
    </body>
</html>
