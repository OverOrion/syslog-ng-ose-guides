<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd"><body name="configuring-flow-control" oldrole="section">
<h1 name="configuring-flow-control" xmlns="http://docbook.org/ns/docbook">Configuring flow-control</h1>
<MadCap:keyword term="log paths:['flow-control']"></MadCap:keyword>
<MadCap:keyword term="flow-control"></MadCap:keyword>
<MadCap:keyword term="preventing message loss:['flow-control']"></MadCap:keyword>
<MadCap:keyword term='parameters:[&lt;span class="Code" oldrole="parameter"&gt;log-fetch-limit()&lt;/span&gt;]'></MadCap:keyword>
<MadCap:keyword term='parameters:[&lt;span class="Code" oldrole="parameter"&gt;log-fifo-size()&lt;/span&gt;]'></MadCap:keyword>
<MadCap:keyword term='parameters:[&lt;span class="Code" oldrole="parameter"&gt;log-iw-size()&lt;/span&gt;]'></MadCap:keyword>
<MadCap:keyword term='parameters:[&lt;span class="Code" oldrole="parameter"&gt;max-connections()&lt;/span&gt;]'></MadCap:keyword>
<MadCap:keyword term="output buffer"></MadCap:keyword>
<p oldrole="para">For details on how flow-control works, see <MadCap:xref href="concepts-flow-control.htm#concepts-flow-control"></MadCap:xref>. The summary of the main points is as follows:</p>
<ul oldrole="itemizedlist">
<li oldrole="listitem">
<p oldrole="para">The syslog-ng application normally reads a maximum of <span class="Code" oldrole="parameter">log-fetch-limit()</span> number of messages from a source.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">From TCP and unix-stream sources, syslog-ng reads a maximum of <span class="Code" oldrole="parameter">log-fetch-limit()</span> from every connection of the source. The number of connections to the source is set using the <span class="Code" oldrole="parameter">max-connections()</span> parameter.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">Every destination has an output buffer (<span class="Code" oldrole="parameter">log-fifo-size()</span>).</p>
</li>
<li oldrole="listitem">
<p oldrole="para">Flow-control uses a control window to determine if there is free space in the output buffer for new messages. Every source has its own control window, the <span class="Code" oldrole="parameter">log-iw-size()</span> parameter sets the size of the control window.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">When a source accepts multiple connections, the size of the control window is divided by the value of the <span class="Code" oldrole="parameter">max-connections()</span> parameter and this smaller control window is applied to each connection of the source.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">The output buffer must be larger than the control window of every source that logs to the destination.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">If the control window is full, syslog-ng stops reading messages from the source until some messages are successfully sent to the destination.</p>
</li>
<li oldrole="listitem">
<p oldrole="para">If the output buffer becomes full, and <MadCap:conditionaltext MadCap:conditions="pe">neither disk-buffering nor flow-control is</MadCap:conditionaltext> <MadCap:conditionaltext MadCap:conditions="ose">flow-control is not</MadCap:conditionaltext> used, messages may be lost.</p>
</li>
</ul>
<table cellspacing="0" class="TableStyle-NoteTable_Yellow_DoNotEdit" oldrole="warning" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/NoteTable_Yellow_DoNotEdit.css');"><col class="TableStyle-NoteTable_Yellow_DoNotEdit-Column-Column1" style="width: 0.3in;"></col><col class="TableStyle-NoteTable_Yellow_DoNotEdit-Column-Column2"></col><tbody><tr class="TableStyle-NoteTable_Yellow_DoNotEdit-Body-Body1"><td class="TableStyle-NoteTable_Yellow_DoNotEdit-BodyB-Column1-Body1"><p><img src="../../../Resources/Images/Common/caution.png"/></p></td><td class="TableStyle-NoteTable_Yellow_DoNotEdit-BodyA-Column2-Body1"><span class="Yellow">Caution: </span><p oldrole="para">If you modify the <span class="Code" oldrole="parameter">max-connections()</span> or the <span class="Code" oldrole="parameter">log-fetch-limit()</span> parameter, do not forget to adjust the <span class="Code" oldrole="parameter">log-iw-size()</span> and <span class="Code" oldrole="parameter">log-fifo-size()</span> parameters accordingly.</p></td></tr></tbody></table>
<div class="Example">
<h6 oldrole="example">Example: Sizing parameters for flow-control</h6>
<MadCap:keyword term="log paths:['flow-control']"></MadCap:keyword>
<MadCap:keyword term="flow-control:['example']"></MadCap:keyword>
<p oldrole="para">Suppose that syslog-ng has a source that must accept up to 300 parallel connections. Such situation can arise when a network source receives connections from many clients, or if many applications log to the same socket. Therefore, set the <span class="Code" oldrole="parameter">max-connections()</span> parameter of the source to <span class="Code" oldrole="userinput">300</span>. However, the <span class="Code" oldrole="parameter">log-fetch-limit()</span> (default value: 10) parameter applies to every connection of the source individually, while the <span class="Code" oldrole="parameter">log-iw-size()</span> (default value: 1000) parameter applies to the source. In a worst-case scenario, the destination does not accept any messages, while all 300 connections send at least <span class="Code" oldrole="parameter">log-fetch-limit()</span> number of messages to the source during every poll loop. Therefore, the control window must accommodate at least <span class="Code" oldrole="parameter">max-connections()</span>*<span class="Code" oldrole="parameter">log-fetch-limit()</span> messages to be able to read every incoming message of a poll loop. In the current example this means that (<span class="Code" oldrole="parameter">log-iw-size()</span> should be greater than <span class="Code" oldrole="userinput">300*10=3000</span>. If the control window is smaller than this value, the control window might fill up with messages from the first connections &mdash; causing syslog-ng to read only one message of the last connections in every poll loop.</p>
<p oldrole="para">The output buffer of the destination must accommodate at least <span class="Code" oldrole="parameter">log-iw-size()</span> messages, but use a greater value: in the current example <span class="Code" oldrole="userinput">3000*10=30000</span> messages. That way all incoming messages of ten poll loops fit in the output buffer. If the output buffer is full, syslog-ng does not read any messages from the source until some messages are successfully sent to the destination.</p>
<pre class="Code" oldrole="synopsis">source s_localhost {
            network(ip(127.0.0.1) port(1999) max-connections(300)); };
destination d_tcp {
            network("10.1.2.3" port(1999) localport(999) log-fifo-size(30000)); };
log { source(s_localhost); destination(d_tcp); flags(flow-control); };</pre>
<p oldrole="para">If other sources send messages to this destination, than the output buffer must be further increased. For example, if a network host with maximum <span class="Code" oldrole="userinput">100</span> connections also logs into the destination, than increase the <span class="Code" oldrole="parameter">log-fifo-size()</span> by <span class="Code" oldrole="userinput">10000</span>.</p>
<pre class="Code" oldrole="synopsis">source s_localhost {
            network(ip(127.0.0.1) port(1999) max-connections(300)); };
source s_tcp {
            network(ip(192.168.1.5) port(1999) max-connections(100)); };
destination d_tcp {
            network("10.1.2.3" port(1999) localport(999) log-fifo-size(40000)); };
log { source(s_localhost); destination(d_tcp); flags(flow-control); };</pre>
</div>
</body></html>
