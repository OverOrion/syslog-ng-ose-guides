<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head>
    </head>
    <body name="concepts-logstore-journal" oldrole="section">
        <h1 name="concepts-logstore-journal">Journal files</h1>
        <MadCap:keyword term="journal files">
        </MadCap:keyword>
        <p oldrole="para">The <MadCap:variable name="General.abbrev"></MadCap:variable> application processes log messages into a journal file before writing them to the logstore file. That way logstore files are consistent even if <MadCap:variable name="General.abbrev"></MadCap:variable> crashes unexpectedly, avoiding losing messages. Note that this does not protect against losing messages if the operating system crashes.</p>
        <p oldrole="para">A journal file is automatically created for every logstore file that <MadCap:variable name="General.abbrev"></MadCap:variable> opens. A journal file consists of journal blocks which store the log messages. When a journal block fills up with messages, <MadCap:variable name="General.abbrev"></MadCap:variable> writes the entire block into the logstore file and starts to reuse the journal block (one journal block becomes one chunk in the logstore file). If the messages cannot be written to the logstore file (for example, because the disk becomes unaccessible, or file operations are slow), messages are put to the next journal block (<MadCap:variable name="General.abbrev"></MadCap:variable> uses four blocks by default). When all journal blocks become full, <MadCap:variable name="General.abbrev"></MadCap:variable> will stop processing incoming traffic. <MadCap:variable name="General.abbrev"></MadCap:variable> starts accepting messages to the logstore file again when the first journal block is successfully written to the logstore file. If <MadCap:variable name="General.abbrev"></MadCap:variable> receives a HUP or STOP signal, or no new message arrives into the logstore for the period set in the <span class="Code" oldrole="parameter">time-reap()</span> parameter, it writes every journal block to the logstore.</p>
        <p oldrole="para">When <MadCap:variable name="General.abbrev"></MadCap:variable> is restarted, it automatically processes the journal files to the logstore files, unless a particular logstore file is not part of configuration of <MadCap:variable name="General.abbrev"></MadCap:variable>. Such orphaned journal files can be processed with the <b oldrole="command">lgstool recover</b> command. For details on processing orphaned journal files, see <MadCap:xref href="#lgstool-recover"></MadCap:xref>.</p>
        <table cellspacing="0" class="TableStyle-NoteTable_Yellow_DoNotEdit" oldrole="warning" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/NoteTable_Yellow_DoNotEdit.css');">
            <col class="TableStyle-NoteTable_Yellow_DoNotEdit-Column-Column1" style="width: 0.3in;">
            </col>
            <col class="TableStyle-NoteTable_Yellow_DoNotEdit-Column-Column2">
            </col>
            <tbody>
                <tr class="TableStyle-NoteTable_Yellow_DoNotEdit-Body-Body1">
                    <td class="TableStyle-NoteTable_Yellow_DoNotEdit-BodyB-Column1-Body1">
                        <p>
                            <img src="../../../Resources/Images/Common/caution.png" />
                        </p>
                    </td>
                    <td class="TableStyle-NoteTable_Yellow_DoNotEdit-BodyA-Column2-Body1"><span class="Yellow">Caution: </span>
                        <ul oldrole="itemizedlist">
                            <li oldrole="listitem">
                                <p oldrole="para">If a particular logstore destination receives messages at a constant but very low message rate (for example, a 100-byte message every 30 seconds), messages do not get written to the logstore file for a long time, because the journal block does not get full, and messages are more frequent than the <span class="Code" oldrole="parameter">time-reap()</span> time. This becomes a problem when using logrotate to rotate the logstore files, because log messages will not be in the files they are expected. To avoid this situation, either use time-based macros in the filenames of the logstore files, or send a HUP signal to <MadCap:variable name="General.abbrev"></MadCap:variable> right before rotating the logstore files.</p>
                            </li>
                            <li oldrole="listitem">
                                <p oldrole="para">When every block of a journal becomes full and <MadCap:variable name="General.abbrev"></MadCap:variable> stops processing incoming traffic, <i oldrole="emphasis">it will not read new messages at all</i> until a block is successfully written to the related logstore file. This is in contrast with flow-control, where only messages from the source related to the particular destination are not processed.</p>
                            </li>
                            <li oldrole="listitem">
                                <p oldrole="para">The messages in the journal file are in plain-text format: they are neither encrypted nor compressed. The journal file has the same permission as the logstore, by default, <span class="Code" oldrole="userinput">root</span> privileges are required to access them. Make sure you consider this if you change the permissions of the journal file (owner, group, perm) in the <MadCap:variable name="General.abbrev"></MadCap:variable> configuration file.</p>
                            </li>
                        </ul>
                    </td>
                </tr>
            </tbody>
        </table>
        <table cellspacing="0" class="TableStyle-NoteTable_Blue_DoNotEdit" oldrole="note" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/NoteTable_Blue_DoNotEdit.css');">
            <col class="TableStyle-NoteTable_Blue_DoNotEdit-Column-Column1" style="width: 0.3in;">
            </col>
            <col class="TableStyle-NoteTable_Blue_DoNotEdit-Column-Column2">
            </col>
            <tbody>
                <tr class="TableStyle-NoteTable_Blue_DoNotEdit-Body-Body1">
                    <td class="TableStyle-NoteTable_Blue_DoNotEdit-BodyB-Column1-Body1">
                        <p>
                            <img src="../../../Resources/Images/Common/note.png" />
                        </p>
                    </td>
                    <td class="TableStyle-NoteTable_Blue_DoNotEdit-BodyA-Column2-Body1"><span class="AllNoteStyles">NOTE: </span>
                        <p oldrole="para">Journal files are located in the same folder as the logstore file. The name of the journal file is the same as the logstore file with <span class="Code" oldrole="filename">.jor</span> suffix added. For example, the journal file for <span class="Code" oldrole="filename">messages.lgs</span> is <span class="Code" oldrole="filename">messages.lgs.jor</span>.</p>
                    </td>
                </tr>
            </tbody>
        </table>
        <MadCap:keyword term="memory use of:['logstore journal files']">
        </MadCap:keyword>
        <p oldrole="para">The <MadCap:variable name="General.abbrev"></MadCap:variable> application uses a separate journal file for every logstore file. Every journal file is processed by a separate thread. The journal files are mapped into the memory. The journal of an individual logstore file uses up to <span class="Code" oldrole="userinput">journal-block-size()*journal-block-count()</span> memory address, which is 4MB by default. However, if you have several logstore files open in parallel (for example, you are collecting log messages from 500 hosts and storing them in separate files for every host, and the hosts are continuously sending messages) the memory requirements for journaling rise quickly (to ~2GB for the 500 hosts). To limit the memory use of journals, adjust the <a href="reference-options.htm"><span class="Code" oldrole="parameter">logstore-journal-shmem-threshold()</span></a> global option (by default, it is 512 MB).</p>
        <MadCap:snippetBlock src="../../shared/chunk/option-description-destination-logstore-journal-shmem-threshold.htm">
        </MadCap:snippetBlock>
        <table cellspacing="0" class="TableStyle-NoteTable_Yellow_DoNotEdit" oldrole="warning" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/NoteTable_Yellow_DoNotEdit.css');">
            <col class="TableStyle-NoteTable_Yellow_DoNotEdit-Column-Column1" style="width: 0.3in;">
            </col>
            <col class="TableStyle-NoteTable_Yellow_DoNotEdit-Column-Column2">
            </col>
            <tbody>
                <tr class="TableStyle-NoteTable_Yellow_DoNotEdit-Body-Body1">
                    <td class="TableStyle-NoteTable_Yellow_DoNotEdit-BodyB-Column1-Body1">
                        <p>
                            <img src="../../../Resources/Images/Common/caution.png" />
                        </p>
                    </td>
                    <td class="TableStyle-NoteTable_Yellow_DoNotEdit-BodyA-Column2-Body1"><span class="Yellow">Caution: </span>
                        <p oldrole="para">If you have a large amount of open logstore files in parrallel (for example, you are using the <span class="Code" oldrole="parameter">${HOST}</span> or <span class="Code" oldrole="parameter">${PROGRAM}</span> macros in your filenames) consider lowering the <span class="Code" oldrole="parameter">journal-block-size()</span> to avoid <MadCap:variable name="General.abbrev"></MadCap:variable> consuming the entire memory of the system.</p>
                    </td>
                </tr>
            </tbody>
        </table>
        <MadCap:snippetBlock src="../../shared/chunk/example-logstore-memory-threshold.htm">
        </MadCap:snippetBlock>
    </body>
</html>