<?xml version="1.0" encoding="utf-8"?>
<html xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd">
    <head>
    </head>
    <body name="configuring-destinations-kafka" oldrole="section">
        <h1 name="configuring-destinations-kafka"><span class="Code" oldrole="parameter">kafka</span>: Publishing messages to Apache Kafka</h1>
        <MadCap:keyword term="destination drivers:[&lt;span class=&quot;Code&quot; oldrole=&quot;parameter&quot;&gt;java()&lt;/span&gt;, ' driver']">
        </MadCap:keyword>
        <MadCap:keyword term="destination drivers:[&lt;span class=&quot;Code&quot; oldrole=&quot;parameter&quot;&gt;kafka&lt;/span&gt;]">
        </MadCap:keyword>
        <p oldrole="para">Starting with version <MadCap:conditionaltext MadCap:conditions="pe">5.4</MadCap:conditionaltext><MadCap:conditionaltext MadCap:conditions="syslogngPE.ose">3.7</MadCap:conditionaltext>, <MadCap:variable name="General.abbrev"></MadCap:variable> can directly publish log messages to the <a href="http://kafka.apache.org">Apache Kafka</a> message bus, where subscribers can access them.</p>
        <MadCap:snippetBlock src="../../shared/wnt/note-server-mode-only.htm">
        </MadCap:snippetBlock>
        <ul oldrole="itemizedlist">
            <MadCap:snippetBlock src="../../shared/chunk/listitem-java-supported-platforms.htm">
            </MadCap:snippetBlock>
            <li oldrole="listitem">
                <p oldrole="para">Since <MadCap:variable name="General.abbrev"></MadCap:variable> uses the official Java Kafka producer, the <span class="Code" oldrole="parameter">kafka</span> destination has significant memory usage.</p>
            </li>
            <MadCap:snippetBlock src="../../shared/chunk/listitem-java-internal-messages.htm">
            </MadCap:snippetBlock>
        </ul>
        <h6 oldrole="formalpara">Declaration:</h6><pre class="Code" oldrole="synopsis">@module mod-java
@include "scl.conf"

kafka(
    client-lib-dir("/opt/syslog-ng/lib/syslog-ng/java-modules/:&lt;path-to-preinstalled-kafka-libraries&gt;")
    kafka-bootstrap-servers("1.2.3.4:9092,192.168.0.2:9092")
    topic("${HOST}")

);</pre>
        <div class="Example">
            <h6 name="example-destination-kafka" oldrole="example">Example: Sending log data to Apache Kafka</h6>
            <p oldrole="para">The following example defines a <span class="Code" oldrole="parameter">kafka</span> destination, using only the required parameters.</p><pre class="Code" oldrole="synopsis">@module mod-java
@include "scl.conf"

destination d_kafka {
  kafka(
    client-lib-dir("/opt/syslog-ng/lib/syslog-ng/java-modules/KafkaDestination.jar:/usr/share/kafka/lib/")
    kafka-bootstrap-servers("1.2.3.4:9092,192.168.0.2:9092")
    topic("${HOST}")
  );
};</pre>
        </div>
        <ul oldrole="itemizedlist">
            <li oldrole="listitem">
                <p oldrole="para">To install the software required for the <span class="Code" oldrole="parameter">kafka</span> destination, see <MadCap:xref href="destination-kafka-prerequisites.htm#destination-kafka-prerequisites"></MadCap:xref>.</p>
            </li>
            <li oldrole="listitem">
                <p oldrole="para">For details on how the <span class="Code" oldrole="parameter">kafka</span> destination works, see <MadCap:xref href="destination-kafka.htm#destination-kafka-interaction"></MadCap:xref>.</p>
            </li>
            <li oldrole="listitem">
                <p oldrole="para">For the list of options, see <MadCap:xref href="destination-kafka.htm#reference-destination-kafka"></MadCap:xref>.</p>
            </li>
        </ul>
        <p MadCap:conditions="syslogngPE.ose" oldrole="para">The <span class="Code" oldrole="parameter">kafka()</span> driver is actually a reusable configuration snippet configured to receive log messages using the Java language-binding of <MadCap:variable name="General.abbrev"></MadCap:variable>. For details on using or writing such configuration snippets, see <MadCap:xref href="config-blocks.htm#config-blocks"></MadCap:xref>. You can find the source of the kafka configuration snippet on <a href="https://github.com/balabit/syslog-ng/blob/master/scl/kafka/plugin.conf">GitHub</a>. For details on extending <MadCap:variable name="General.abbrev"></MadCap:variable> in Java, see the <a href="https://syslog-ng.gitbooks.io/getting-started/content/chapters/chapter_5/section_2.html">Getting started with syslog-ng development</a> guide.</p>
        <MadCap:snippetBlock src="destination-kafka-prerequisites.htm">
        </MadCap:snippetBlock>
        <h2 name="destination-kafka-interaction">How <MadCap:variable name="General.abbrev"></MadCap:variable> interacts with Apache Kafka</h2>
        <p oldrole="para">When stopping the <MadCap:variable name="General.abbrev"></MadCap:variable> application, <MadCap:variable name="General.abbrev"></MadCap:variable> will not stop until all Java threads are finished, including the threads started by the Kafka Producer. There is no way (except for the <b oldrole="command">kill -9</b> command) to stop <MadCap:variable name="General.abbrev"></MadCap:variable> before the Kafka Producer stops. To change this behavior set the properties of the Kafka Producer in its properties file, and reference the file in the <span class="Code" oldrole="parameter">properties-file</span> option.</p>
        <p oldrole="para">The <MadCap:variable name="General.abbrev"></MadCap:variable> <span class="Code" oldrole="parameter">kafka</span> destination tries to reconnect to the brokers in a tight loop. This can look as spinning, because of a lot of similar debug messages. To decrease the amount of such messages, set a bigger timeout using the following properties:</p><pre class="Code" oldrole="synopsis">retry.backoff.ms=1000
reconnect.backoff.ms=1000</pre>
        <p oldrole="para">For details on using property files, see <MadCap:xref href="destination-kafka.htm#kafka-option-properties-file"></MadCap:xref>. For details on the properties that you can set in the property file, see the <a href="http://kafka.apache.org/documentation.html#newproducerconfigs">Apache Kafka documentation</a>.</p>
        <h2 name="reference-destination-kafka">Kafka destination options</h2>
        <MadCap:keyword term="destination drivers:[&lt;span class=&quot;Code&quot; oldrole=&quot;parameter&quot;&gt;java()&lt;/span&gt;, ' driver']">
        </MadCap:keyword>
        <MadCap:keyword term="destination drivers:[&lt;span class=&quot;Code&quot; oldrole=&quot;parameter&quot;&gt;kafka&lt;/span&gt;]">
        </MadCap:keyword>
        <p oldrole="para">The <span class="Code" oldrole="parameter">kafka</span> destination of <MadCap:variable name="General.abbrev"></MadCap:variable> can directly publish log messages to the <a href="http://kafka.apache.org">Apache Kafka</a> message bus, where subscribers can access them. The <span class="Code" oldrole="parameter">kafka</span> destination has the following options.</p>
        <h6 oldrole="formalpara">Required options:</h6>
        <p oldrole="para">The following options are required: <span class="Code" oldrole="parameter">kafka-bootstrap-servers()</span>, <span class="Code" oldrole="parameter">topic()</span>. Note that to use <span class="Code" oldrole="parameter">kafka</span>, you must add the following lines to the beginning of your <MadCap:variable name="General.abbrev"></MadCap:variable> configuration:</p><pre class="Code" oldrole="synopsis">@module mod-java
@include "scl.conf"</pre>
        <MadCap:snippetBlock src="../../shared/chunk/option-destination-java-class-path.htm">
        </MadCap:snippetBlock>
        <p oldrole="para">For the <span class="Code" oldrole="parameter">kafka</span> destination, include the path to the directory where you copied the required libraries (see <MadCap:xref href="destination-kafka-prerequisites.htm#destination-kafka-prerequisites"></MadCap:xref>), for example, <span class="Code" oldrole="userinput">client-lib-dir("/opt/syslog-ng/lib/syslog-ng/java-modules/KafkaDestination.jar:/usr/share/kafka/lib/*.jar")</span>.</p>
        <h6 name="kafka-option-kafka-bootstrap-servers" oldrole="simplesect">kafka-bootstrap-servers()</h6>
        <MadCap:keyword term="kafka-bootstrap-servers():['kafka']">
        </MadCap:keyword>
        <MadCap:keyword term="kafka:['kafka-bootstrap-servers()']">
        </MadCap:keyword>
        <MadCap:keyword term="kafka:['server']">
        </MadCap:keyword>
        <table cellspacing="0" class="RuledTableWithHeading_DoNotEdit" colsep="0" frame="topbot" rowsep="0" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/RuledTableWithHeading_DoNotEdit.css');">
            <tbody>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Type: 

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">list of hostnames</td>
                </tr>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Default: 

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    </td>
                </tr>
            </tbody>
            <col class="TableStyle-RuledTableWithHeading_DoNotEdit-Column-Column1" style="width: 0.3in;">
            </col>
        </table>
        <p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> Specifies the hostname or IP address of the Kafka server. When specifying an IP address, IPv4 (for example, <span class="Code" oldrole="userinput">192.168.0.1</span>) or IPv6 (for example, <span class="Code" oldrole="userinput">[::1]</span>) can be used as well. Use a colon (<span class="Code" oldrole="userinput">:</span>) after the address to specify the port number of the server. When specifying multiple addresses, use a comma to separate the addresses, for example, <span class="Code" oldrole="userinput">kafka-bootstrap-servers("127.0.0.1:2525,remote-server-hostname:6464")</span></p>
        <MadCap:snippetBlock src="../../shared/chunk/option-destination-frac-digits.htm">
        </MadCap:snippetBlock>
        <MadCap:snippetBlock src="../../shared/chunk/option-destination-jvm-options.htm">
        </MadCap:snippetBlock>
        <MadCap:snippetBlock src="../../shared/chunk/option-destination-on-error.htm">
        </MadCap:snippetBlock>
        <h6 name="kafka-option-key" oldrole="simplesect">key()</h6>
        <MadCap:keyword term="key():['kafka']">
        </MadCap:keyword>
        <MadCap:keyword term="kafka:['key']">
        </MadCap:keyword>
        <table cellspacing="0" class="RuledTableWithHeading_DoNotEdit" colsep="0" frame="topbot" rowsep="0" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/RuledTableWithHeading_DoNotEdit.css');">
            <tbody>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Type: 

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">template</td>
                </tr>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Default: 

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">N/A</td>
                </tr>
            </tbody>
            <col class="TableStyle-RuledTableWithHeading_DoNotEdit-Column-Column1" style="width: 0.3in;">
            </col>
        </table>
        <p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The key of the partition under which the message is published. You can use templates to change the topic dynamically based on the source or the content of the message, for example, <span class="Code" oldrole="userinput">key("${PROGRAM}")</span>.</p>
        <MadCap:snippetBlock src="../../shared/chunk/option-destination-log-fifo-size.htm">
        </MadCap:snippetBlock>
        <h6 name="kafka-option-properties-file" oldrole="simplesect">properties-file()</h6>
        <MadCap:keyword term="properties-file():['kafka']">
        </MadCap:keyword>
        <MadCap:keyword term="properties-file:['resource']">
        </MadCap:keyword>
        <table cellspacing="0" class="RuledTableWithHeading_DoNotEdit" colsep="0" frame="topbot" rowsep="0" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/RuledTableWithHeading_DoNotEdit.css');">
            <tbody>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Type: 

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">string (absolute path)</td>
                </tr>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Default: 

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">N/A</td>
                </tr>
            </tbody>
            <col class="TableStyle-RuledTableWithHeading_DoNotEdit-Column-Column1" style="width: 0.3in;">
            </col>
        </table>
        <p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The absolute path and filename of the Kafka properties file to load. For example, <span class="Code" oldrole="userinput">properties-file("/opt/syslog-ng/etc/kafka_dest.properties")</span>. The <MadCap:variable name="General.abbrev"></MadCap:variable> application reads this file and passes the properties to the Kafka Producer. If a property is defined both in the <MadCap:variable name="General.abbrev"></MadCap:variable> configuration file (<span class="Code" oldrole="filename">syslog-ng.conf</span>) and in the properties file, then <MadCap:variable name="General.abbrev"></MadCap:variable> uses the definition from the <MadCap:variable name="General.abbrev"></MadCap:variable> configuration file.</p>
        <p oldrole="para">The <MadCap:variable name="General.abbrev"></MadCap:variable> <span class="Code" oldrole="parameter">kafka</span> destination supports all properties of the official Kafka producer. For details, see the <a href="http://kafka.apache.org/documentation.html#newproducerconfigs">Apache Kafka documentation</a>.</p>
        <p oldrole="para">The <span class="Code" oldrole="parameter">kafka-bootstrap-servers</span> option is translated to the <span class="Code" oldrole="userinput">bootstrap.servers</span> property.</p>
        <p oldrole="para">For example, the following properties file defines the acknowledgement method and compression:</p><pre class="Code" oldrole="synopsis">acks=all
compression.type=snappy</pre>
        <MadCap:snippetBlock src="../../shared/chunk/option-destination-retries.htm">
        </MadCap:snippetBlock>
        <h6 name="kafka-option-sync-send" oldrole="simplesect">sync-send()</h6>
        <MadCap:keyword term="sync-send():['kafka']">
        </MadCap:keyword>
        <MadCap:keyword term="kafka:['sync-send']">
        </MadCap:keyword>
        <table cellspacing="0" class="RuledTableWithHeading_DoNotEdit" colsep="0" frame="topbot" rowsep="0" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/RuledTableWithHeading_DoNotEdit.css');">
            <tbody>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Type: 

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">true | false</td>
                </tr>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Default: 

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">false</td>
                </tr>
            </tbody>
            <col class="TableStyle-RuledTableWithHeading_DoNotEdit-Column-Column1" style="width: 0.3in;">
            </col>
        </table>
        <p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> When <span class="Code" oldrole="parameter">sync-send</span> is set to <span class="Code" oldrole="userinput">true</span>, <MadCap:variable name="General.abbrev"></MadCap:variable> sends the message reliably: it sends a message to the Kafka server, then waits for a reply. In case of failure, <MadCap:variable name="General.abbrev"></MadCap:variable> repeats sending the message, as set in the <span class="Code" oldrole="parameter">retries()</span> parameter. If sending the message fails for <span class="Code" oldrole="parameter">retries()</span> times, <MadCap:variable name="General.abbrev"></MadCap:variable> drops the message.</p>
        <p oldrole="para">This method ensures reliable message transfer, but is very slow.</p>
        <p oldrole="para">When <span class="Code" oldrole="parameter">sync-send</span> is set to <span class="Code" oldrole="userinput">false</span>, <MadCap:variable name="General.abbrev"></MadCap:variable> sends messages asynchronously, and receives the response asynchronously. In case of a problem, <MadCap:variable name="General.abbrev"></MadCap:variable> cannot resend the messages.</p>
        <p oldrole="para">This method is fast, but the transfer is not reliable. Several thousands of messages can be lost before <MadCap:variable name="General.abbrev"></MadCap:variable> recognizes the error.</p>
        <h6 name="kafka-option-template" oldrole="simplesect">template()</h6>
        <MadCap:keyword term="message-template():['kafka']">
        </MadCap:keyword>
        <MadCap:keyword term="kafka:['template']">
        </MadCap:keyword>
        <table cellspacing="0" class="RuledTableWithHeading_DoNotEdit" colsep="0" frame="topbot" rowsep="0" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/RuledTableWithHeading_DoNotEdit.css');">
            <tbody>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Type: 

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">template or template function</td>
                </tr>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Default: 

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">$ISODATE $HOST $MSGHDR$MSG\n</td>
                </tr>
            </tbody>
            <col class="TableStyle-RuledTableWithHeading_DoNotEdit-Column-Column1" style="width: 0.3in;">
            </col>
        </table>
        <p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The message as published to Apache Kafka. You can use templates and template functions (for example, <span class="Code" oldrole="parameter">format-json()</span>) to format the message, for example, <span class="Code" oldrole="userinput">template("$(format-json --scope rfc5424 --exclude DATE --key ISODATE)")</span>.</p>
        <p oldrole="para">For details on formatting messages in JSON format, see <MadCap:xref href="reference-template-functions.htm#template-function-format-json"></MadCap:xref>.</p>
        <MadCap:snippetBlock src="../../shared/chunk/option-destination-throttle.htm">
        </MadCap:snippetBlock>
        <h6 name="kafka-option-kafka-topic" oldrole="simplesect">topic()</h6>
        <MadCap:keyword term="topic():['kafka']">
        </MadCap:keyword>
        <MadCap:keyword term="kafka:['topic']">
        </MadCap:keyword>
        <table cellspacing="0" class="RuledTableWithHeading_DoNotEdit" colsep="0" frame="topbot" rowsep="0" style="width: 100%;mc-table-style: url('../../../Resources/TableStyles/RuledTableWithHeading_DoNotEdit.css');">
            <tbody>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Type: 

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">template</td>
                </tr>
                <tr class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">Default: 

                            </td>
                    <td class="TableStyle-RuledTableWithHeading_DoNotEdit-Body-Body1">N/A</td>
                </tr>
            </tbody>
            <col class="TableStyle-RuledTableWithHeading_DoNotEdit-Column-Column1" style="width: 0.3in;">
            </col>
        </table>
        <p oldrole="para"><i oldrole="emphasis" role="bold">Description:</i> The Kafka topic under which the message is published. You can use templates to change the topic dynamically based on the source or the content of the message, for example, <span class="Code" oldrole="userinput">topic("${HOST}")</span>.</p>
        <MadCap:snippetBlock src="../../shared/chunk/option-destination-timezone.htm">
        </MadCap:snippetBlock>
        <MadCap:snippetBlock src="../../shared/chunk/option-destination-ts-format.htm">
        </MadCap:snippetBlock>
    </body>
</html>