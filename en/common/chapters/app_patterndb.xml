<?xml version='1.0' encoding='ISO-8859-1'?>
<!DOCTYPE appendix SYSTEM "../../xml-stylesheet/pdf/dtd/docbookx.dtd"
 [  <!ENTITY % entities SYSTEM "../../syslog-ng-admin-guide/syslog-ng-entities.ent">
 %entities;]> 
<appendix id="app-patterndb">
  <title>Deprecated pattern database schemes</title>
  <para>This appendix describes the older versions of the syslog-ng pattern database. 
  These descriptions are only for reference, if you want to create a pattern database, you are recommended to 
  use the latest format: V3, which is supported by syslog-ng version 3.1 and later, and the syslog-ng Store 
  Box version 1.1 and later.</para>
  <note>
  <para>Note that V3 is backwards compatible with the V2 format, meaning that applications that support V3 can 
  use pattern databases in the V2 format as well (but not V1). To convert your existing pattern databases to the V3 format, use the <command>pdbtool</command> application bundled with syslog-ng 3.1 and later. See the manual 
  page of <command>pdbtool</command> for details.</para></note>
  <section id="patterndb-format-v1">
    <title>The syslog-ng pattern database format V1</title>
  <para>The XML schema of the V1 pattern database used in syslog-ng OSE and PE 3.0.X is described below. 
  Newer versions syslog-ng 3.1 and later use an updated V3 format that 
                    is described in <xref linkend="reference_patterndb_schemes"/>. </para>                
  <note>
  <para>Note that V3 is backwards compatible with the V2 format, meaning that applications that support V3 can 
  use pattern databases in the V2 format as well (but not V1). To convert your existing pattern databases to the V3 format, use the <command>pdbtool</command> application bundled with syslog-ng 3.1 and later. See the manual 
  page of <command>pdbtool</command> for details.</para></note>
                <itemizedlist id="reference_patterndb_scheme_v1">
                    <listitem>
                        <para><guimenu>&lt;patterndb&gt;</guimenu>: The container element of
                            the pattern database. For example:
                            <synopsis>&lt;patterndb version='1' pub_date='2008-08-25'&gt;</synopsis></para>
                    </listitem>
                    <listitem>
                        <para><emphasis>version</emphasis>: The schema version of the pattern
                            database. The current version is <parameter>2</parameter>.</para>
                    </listitem>
                    <listitem>
                        <para><emphasis>pubdate</emphasis>: The publication date of the XML
                        file.</para>
                    </listitem>
                    <listitem>
                        <para><guimenu>&lt;program&gt;</guimenu>: A container element to
                            group log patterns for an application or program. For example:
                            <synopsis>&lt;program name='su' id='480de478-d4a6-4a7f-bea4-0c0245d361e1'&gt;</synopsis>
                        </para>
                        <para><parameter>&lt;patterndb&gt;</parameter> element may contain
                            any number of <guimenu>&lt;program&gt;</guimenu> elements.</para>
                        <itemizedlist>
                            <listitem>
                                <para><emphasis>name</emphasis>: The name of the application. Note
                                    that the function of this attribute is to make the database more
                                    readable, syslog-ng uses the
                                    <parameter>&lt;pattern&gt;</parameter> element to
                                    identify the applications sending log messages.</para>
                            </listitem>
                            <listitem>
                                <para><emphasis>id</emphasis>: A unique ID of the application, for
                                    example, the md5 sum of the <parameter>name</parameter>
                                    attribute.</para>
                            </listitem>
                            <listitem>
                                <para><guimenu>pattern</guimenu>: The name of the application
                                    &mdash; syslog-ng matches this value to the $PROGRAM header
                                    of the syslog message to find the rulesets applicable to the
                                    syslog message. This element is also called <parameter>program
                                        pattern</parameter>. E.g.,
                                    <synopsis>&lt;pattern&gt;su&lt;/pattern&gt;</synopsis>
                                </para>
                            </listitem>
                            <listitem>
                                <para><guimenu>description</guimenu>: OPTIONAL &mdash; A
                                    description of the ruleset or the application.</para>
                            </listitem>
                            <listitem>
                                <para><guimenu>url</guimenu>: OPTIONAL &mdash; An URL referring
                                    to further information about the ruleset or the
                                application.</para>
                            </listitem>
                            <listitem>
                                <para><guimenu>&lt;rules&gt;</guimenu>: A container element
                                    for the rules of the ruleset.</para>
                                <itemizedlist>
                                    <listitem>
                                        <para><guimenu>&lt;rule&gt;</guimenu>: An element
                                            containing message patterns and how a message that
                                            matches these patterns is classified. For example:
                                            <synopsis>&lt;rule provider='balabit' id='f57196aa-75fd-11dd-9bba-001e6806451b' class='violation'&gt;</synopsis>
                                        </para>
                                        <note>
                                            <para>If the following characters appear in the message,
                                                they must be escaped in the rule as follows:</para>
                                            <itemizedlist>
                                                <listitem>
                                                  <para><parameter>@</parameter>: Use @@, e.g.,
                                                  <parameter>user@@example.com</parameter></para>
                                                </listitem>
                                                <listitem>
                                                  <para><emphasis>&lt;</emphasis>: Use
                                                  <parameter>&amp;lt;</parameter></para>
                                                </listitem>
                                                <listitem>
                                                  <para><emphasis>&gt;</emphasis>: Use
                                                  <parameter>&amp;gt;</parameter></para>
                                                </listitem>
                                                <listitem>
                                                  <para>&amp;: Use
                                                  <parameter>&amp;amp;</parameter></para>
                                                </listitem>
                                            </itemizedlist>
                                        </note>
                                        <para>The <guimenu>&lt;rules&gt;</guimenu> element
                                            may contain any number of
                                            <guimenu>&lt;rule&gt;</guimenu> elements.</para>
                                    </listitem>
                                    <listitem>
                                        <para><emphasis>provider</emphasis>: The provider of the
                                            rule. This is used to distinguish between who supplied
                                            the rule; i.e., if it has been created by BalaBit, or
                                            added to the xml by a local user.</para>
                                    </listitem>
                                    <listitem>
                                        <para><emphasis>id</emphasis>: The globally unique ID of the
                                            rule.</para>
                                    </listitem>
                                    <listitem>
                                        <para><emphasis>class</emphasis>: The class of the rule
                                            &mdash; syslog-ng assigns this class to the messages
                                            matching a pattern of this rule.</para>
                                    </listitem>
                                    <listitem>
                                        <para><guimenu>&lt;pattern&gt;</guimenu>: A pattern
                                            describing a log message. This element is also called
                                                <parameter>message pattern</parameter>. For example:
                                            <synopsis>&lt;pattern&gt;+ ??? root-&lt;/pattern&gt;</synopsis></para>
                                    </listitem>
                                </itemizedlist>
                            </listitem>
                        </itemizedlist>
                    </listitem>
                </itemizedlist>

                <example id="example_pattern_database_v1_pf">
                    <title>A V1 pattern database containing a single rule</title>
                    <indexterm>
                        <primary>pattern database</primary>
                    </indexterm>
                    <para>The following pattern database contains a single rule that matches log
                        messages of the <parameter>PF</parameter> packet-filtering application. A
                        sample log message looks like:</para>
                    <synopsis>PF: DROP filter/INPUT IN=eth0 OUT= MAC=00:1A:4B:80:90:C9:00:1A:4B:80:90:C6 SRC=192.168.155.11 DST=192.168.155.1 LEN=60 TOS=0x10 PREC=0x00 TTL=64 ID=51939 DF PROTO=TCP SPT=34407 DPT=80 WINDOW=32792 RES=0x00 SYN URGP=0</synopsis>
                    <para>The following is a simple pattern database containing a matching rule.</para>
                    <synopsis>&lt;patterndb version='1' pub_date='2009-04-17'&gt;
    &lt;program name='PF'&gt;
        &lt;pattern&gt;PF&lt;/pattern&gt;
            &lt;rule id='1' class='pf'&gt;
                &lt;pattern&gt;@STRING:PF.VERDICT@ @STRING:PF.CHAIN:/@ IN=@STRING:PF.IN_IFACE@ OUT= MAC=@STRING:PF.MAC::@ SRC=@IPV4:PF.SRC_IP@ DST=@IPV4:PF.DST_IP@ LEN=@NUMBER:PF.PKT_LEN@ TOS=@STRING:PF.TOS@ PREC=@STRING:PF.PREC@ TTL=@NUMBER:PF.TTL@ ID=@NUMBER:PF.ID@ DF PROTO=@STRING:PF.PROTO@ SPT=@NUMBER:PF.SRC_PORT@ DPT=@NUMBER:PF.DST_PORT@ WINDOW=@NUMBER:PF.TCP_WINDOW@ RES=@STRING:PF.RES@ SYN URGP=@NUMBER:PF.TCP_URGP@&lt;/pattern&gt;
            &lt;/rule&gt;
    &lt;/program&gt;
&lt;/patterndb&gt;</synopsis>
                    <para>Note that the rule uses macros that refer to parts of the message, for
                        example, you can use the <parameter>$PF.DST_IP</parameter> macro refer to
                        the destination IP address of the logged connection+.</para>
                </example>
  </section>
  <section id="patterndb-format-v2">
    <title>The syslog-ng pattern database format V2</title>
  <para>The XML schema of the V2 pattern database is described below. 
  Newer versions syslog-ng and the syslog-ng Store Box use an updated V3 format that 
                    is described in <xref linkend="reference_patterndb_schemes"/>. </para>                
  <note>
  <para>Note that V3 is backwards compatible with the V2 format, meaning that applications that support V3 can 
  use pattern databases in the V2 format as well (but not V1). To convert your existing pattern databases to the V3 format, use the <command>pdbtool</command> application bundled with syslog-ng 3.1 and later. See the manual 
  page of <command>pdbtool</command> for details.</para></note>
  
  <para>The following scheme describes the V2 format of the pattern database. This
                    format is used by the syslog-ng Store Box (SSB) appliance version 1.0.x (see
                        <ulink
                        url="http://www.balabit.com/network-security/syslog-ng/log-server-appliance/"
                        >http://www.balabit.com/network-security/syslog-ng/log-server-appliance/</ulink>
                    for details).</para>
                <para>For a sample database containing only a single pattern, see <xref
                        linkend="example_pattern_database_v2_su"/>.</para>
                <itemizedlist id="reference_patterndb_scheme_v2">
                    <listitem>
                        <para><guimenu>&lt;patterndb&gt;</guimenu>: The container element of
                            the pattern database. For example:
                            <synopsis>&lt;patterndb version='2' pub_date='2008-08-25'&gt;</synopsis></para>
                    </listitem>
                    <listitem>
                        <para><emphasis>version</emphasis>: The schema version of the pattern
                            database. The current version is <parameter>2</parameter>.</para>
                    </listitem>
                    <listitem>
                        <para><emphasis>pubdate</emphasis>: The publication date of the XML
                        file.</para>
                    </listitem>
                    <listitem>
                        <para><guimenu>&lt;ruleset&gt;</guimenu>: A container element to
                            group log patterns for an application or program. For example:
                            <synopsis>&lt;ruleset name='su' id='480de478-d4a6-4a7f-bea4-0c0245d361e1'&gt;</synopsis></para>
                        <para> A <parameter>&lt;patterndb&gt;</parameter> element may
                            contain any number of <guimenu>&lt;ruleset&gt;</guimenu>
                            elements.</para>
                        <itemizedlist>
                            <listitem>
                                <para><emphasis>name</emphasis>: The name of the application. Note
                                    that the function of this attribute is to make the database more
                                    readable, syslog-ng uses the
                                    <parameter>&lt;pattern&gt;</parameter> element to
                                    identify the applications sending log messages.</para>
                            </listitem>
                            <listitem>
                                <para><emphasis>id</emphasis>: A unique ID of the application, for
                                    example, the md5 sum of the <parameter>name</parameter>
                                    attribute.</para>
                            </listitem>
                            <listitem>
                                <para><guimenu>description</guimenu>: OPTIONAL &mdash; A
                                    description of the ruleset or the application.</para>
                            </listitem>
                            <listitem>
                                <para><guimenu>url</guimenu>: OPTIONAL &mdash; An URL referring
                                    to further information about the ruleset or the
                                application.</para>
                            </listitem>
                            <listitem>
                                <para><guimenu>pattern</guimenu>: The name of the application
                                    &mdash; syslog-ng matches this value to the $PROGRAM header
                                    of the syslog message to find the rulesets applicable to the
                                    syslog message. This element is also called <parameter>program
                                        pattern</parameter>. E.g., <synopsis>&lt;pattern&gt;su&lt;/pattern&gt;</synopsis>
                                    <note>
                                        <para>If the <parameter>&lt;pattern&gt;</parameter>
                                            element of a ruleset is not specified, -ng will use this
                                            ruleset as a fallback ruleset: it will apply the ruleset
                                            to messages that have an empty PROGRAM header, or if
                                            none of the program patterns matched the PROGRAM header
                                            of the incoming message. </para>
                                    </note>
                                </para>
                            </listitem>
                            <listitem>
                                <para><guimenu>&lt;rules&gt;</guimenu>: A container element
                                    for the rules of the ruleset.</para>
                                <itemizedlist>
                                    <listitem>
                                        <para><guimenu>&lt;rule&gt;</guimenu>: An element
                                            containing message patterns and how a message that
                                            matches these patterns is classified. For example:
                                            <synopsis>&lt;rule provider='balabit'
                                                id='f57196aa-75fd-11dd-9bba-001e6806451b'
                                                class='violation'&gt;</synopsis></para>
                                        <note>
                                            <para>If the following characters appear in the message,
                                                they must be escaped in the rule as follows:</para>
                                            <itemizedlist>
                                                <listitem>
                                                  <para><parameter>@</parameter>: Use @@, e.g.,
                                                  <parameter>user@@example.com</parameter></para>
                                                </listitem>
                                                <listitem>
                                                  <para><emphasis>&lt;</emphasis>: Use
                                                  <parameter>&amp;lt;</parameter></para>
                                                </listitem>
                                                <listitem>
                                                  <para><emphasis>&gt;</emphasis>: Use
                                                  <parameter>&amp;gt;</parameter></para>
                                                </listitem>
                                                <listitem>
                                                  <para>&amp;: Use
                                                  <parameter>&amp;amp;</parameter></para>
                                                </listitem>
                                            </itemizedlist>
                                        </note>
                                        <para>The <guimenu>&lt;rules&gt;</guimenu> element
                                            may contain any number of
                                            <guimenu>&lt;rule&gt;</guimenu> elements.</para>
                                    </listitem>
                                    <listitem>
                                        <para><emphasis>provider</emphasis>: The provider of the
                                            rule. This is used to distinguish between who supplied
                                            the rule; i.e., if it has been created by BalaBit, or
                                            added to the xml by a local user.</para>
                                    </listitem>
                                    <listitem>
                                        <para><emphasis>id</emphasis>: The globally unique ID of the
                                            rule.</para>
                                    </listitem>
                                    <listitem>
                                        <para><emphasis>class</emphasis>: The class of the rule
                                            &mdash; syslog-ng assigns this class to the messages
                                            matching a pattern of this rule.</para>
                                    </listitem>

                                    <listitem>
                                        <para><guimenu>&lt;patterns&gt;</guimenu>: An
                                            element containing the patterns of the rule. If a
                                                <guimenu>&lt;patterns&gt;</guimenu> element
                                            contains multiple
                                            <guimenu>&lt;pattern&gt;</guimenu> elements, the
                                            class of the <guimenu>&lt;rule&gt;</guimenu> is
                                            assigned to every syslog message matching any of the
                                            patterns. </para>
                                        <itemizedlist>
                                            <listitem>
                                                <para><guimenu>&lt;pattern&gt;</guimenu>: A
                                                  pattern describing a log message. This element
                                                  is also called <parameter>message
                                                  pattern</parameter>. For example:
                                                  <synopsis>&lt;pattern&gt;+ ??? root-&lt;/pattern&gt;</synopsis></para>
                                            </listitem>
                                            <listitem>
                                                <para><guimenu>description</guimenu>: OPTIONAL
                                                  &mdash; A description of the pattern or the
                                                  log message matching the pattern. </para>
                                            </listitem>
                                            <listitem>
                                                <para><guimenu>urls</guimenu>: OPTIONAL &mdash;
                                                  An element containing one or more URLs referring
                                                  to further information about the patterns or the
                                                  matching log messages.</para>
                                                <itemizedlist>
                                                  <listitem>
                                                  <para><guimenu>url</guimenu>: OPTIONAL
                                                  &mdash; An URL referring to further
                                                  information about the patterns or the
                                                  matching log messages.</para>
                                                  </listitem>
                                                </itemizedlist>
                                            </listitem>
                                            <listitem>
                                                <para><guimenu>tags</guimenu>: OPTIONAL &mdash;
                                                  An element containing custom keywords (tags)
                                                  about the rules. The tags can be used to label
                                                  specific events (e.g., user logons).</para>
                                                <itemizedlist>
                                                  <listitem>
                                                  <para><guimenu>tag</guimenu>: OPTIONAL
                                                  &mdash; A keyword or tags applied to
                                                  messages matching the rule. For example:
                                                  <synopsis>&lt;tags&gt;&lt;tag&gt;UserLogin&lt;/tag&gt;&lt;/tags&gt;</synopsis></para>
                                                  </listitem>
                                                </itemizedlist>
                                            </listitem>
                                        </itemizedlist>
                                    </listitem>
                                </itemizedlist>
                            </listitem>
                        </itemizedlist>
                    </listitem>
                </itemizedlist>
                <example id="example_pattern_database_v2_su">
                    <title>A V2 pattern database containing a single rule</title>
                    <indexterm>
                        <primary>pattern database</primary>
                    </indexterm>
                    <para>The following pattern database contains a single rule that matches a log
                        message of the <parameter>ssh</parameter> application. A sample log message
                        looks like:</para>
                    <synopsis>Accepted password for sampleuser from 10.50.0.247 port 42156 ssh2</synopsis>
                    <para>The following is a simple pattern database containing a matching rule.</para>
                    <synopsis>&lt;patterndb version='2' pub_date='2009-04-17'&gt;
    &lt;ruleset name='ssh' id='123456678'&gt;
        &lt;pattern&gt;ssh&lt;/pattern&gt;
            &lt;rules&gt;
                &lt;rule provider='me' id='182437592347598' class='system'&gt;
                    &lt;patterns&gt;
                        &lt;pattern&gt;Accepted @QSTRING:SSH.AUTH_METHOD: @ for@QSTRING:SSH_USERNAME: @from\ @QSTRING:SSH_CLIENT_ADDRESS: @port @NUMBER:SSH_PORT_NUMBER:@ ssh2&lt;/pattern&gt;
                    &lt;/patterns&gt;
                &lt;/rule&gt;
            &lt;/rules&gt;
    &lt;/ruleset&gt;
&lt;/patterndb&gt;</synopsis>
                    <para>Note that the rule uses macros that refer to parts of the message, for
                        example, you can use the <parameter>$SSH_USERNAME</parameter> macro refer to
                        the username used in the connection.</para>
                </example>
  </section>
</appendix>
