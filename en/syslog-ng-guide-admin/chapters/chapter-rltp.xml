<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
 [  <!ENTITY % entities SYSTEM "../../shared/syslog-ng-entities.ent">
 %entities;]>
<chapter xml:id="chapter-rltp" xmlns="http://docbook.org/ns/docbook" version="5.0" condition="pe6">
    <title><trademark>Reliable Log Transfer Protocol</trademark>
    </title>
<!-- FIXME jumplist -->
    <section xml:id="concepts-rltp">
        <title>Logging using <trademark>RLTP</trademark>
        </title>
        <indexterm>
            <primary><trademark>RLTP</trademark></primary>
        </indexterm>
        <indexterm>
            <primary>log transfer protocol</primary>
            <secondary>reliable</secondary>
        </indexterm>
        <indexterm>
            <primary>transport</primary>
            <secondary>TCP</secondary>
        </indexterm>
        <para xml:id="para-rltp-intro">The &abbrev; application can send and receive log messages in a reliable way over the TCP transport layer using the <trademark>Reliable Log Transfer Protocol</trademark> (<trademark>RLTP</trademark>). <trademark>RLTP</trademark> is a proprietary transport protocol that prevents message loss during connection breaks. The transport is used between &abbrev; hosts (for example, a client and a server, or a client-simplesect--server), and interoperates with the flow-control and reliable disk-buffer mechanisms of &abbrev;, thus providing the best way to prevent message loss. The sender detects which messages has the receiver successfully received. If messages are lost during the transfer, the sender resends the missing messages, starting from the last successfully received message. Therefore, messages are not duplicated at the receiving end in case of a connection break (however, in failover mode this is not completely ensured). <trademark>RLTP</trademark> also allows to receive encrypted and non-encrypted connections on the same port, using a single source driver.</para>
        <note>
            <para>Because of the communication overhead, the <trademark>RLTP</trademark> protocol is slower than other transport protocols, which might be a problem if you need to collect a high amount (over 200000 messages per second) of log messages on your log server. For performance details of &abbrev; see the <emphasis>syslog-ng Premium Edition Performance Guideline</emphasis> at the &doc-site;.</para>
        </note>
        <note>
            <para>Make sure that you have set the value of the <parameter>log_msg_size()</parameter> parameter large enough in your configuration. If its size is less than the size of the sent messages, it might result in disk fill-up and no incoming logs.</para>
        </note>
        <warning>
            <xi:include href="../../shared/chunk/rltp-losing-messages.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
        </warning>
        <para>The <trademark>RLTP</trademark> protocol works on top of TCP, and can use STARTTLS for encryption. <trademark>RLTP</trademark> supports IPv4 and IPv6 addresses. Inside the <trademark>RLTP</trademark> message, the message can use any format, for example, RFC3164 (BSD-syslog) or RFC5424 (IETF-syslog). The default port of <trademark>RLTP</trademark> is <userinput>35514</userinput>.</para>
        <para><trademark>RLTP</trademark> can be added to the configuration like a transport protocol within the <parameter>syslog()</parameter> driver and the <parameter>network()</parameter> driver.</para>
                <xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="procedure-rltp-concepts.xml"/>
        <section xml:id="rltp-client-simplesect--server">
            <title>Using <trademark>RLTP</trademark> in a client-simplesect--server scenario</title>
            <para>You can use <trademark>RLTP</trademark> between multiple &abbrev; hosts, for example, in a client-simplesect--server scenario. In such case, the communication described in <xref linkend="procedure-rltp-concepts"/> applies both between the client and the simplesect-, and the simplesect- and the server. However, note the following points:</para>
            <itemizedlist>
                <listitem>
                    <para>Unless you use disk-buffer on the simplesect-, the simplesect- waits for acknowledgement from the server before acknowledging the messages to the client. If you send the messages in large batches, and the server can process the messages slowly (or the network connection is slow), you might have to adjust the <parameter>message-acknowledgement-timeout()</parameter> on the client.</para>
                </listitem>
                <listitem>
                    <para>If you use reliable disk-buffer on the simplesect-, the simplesect- will acknowledge the messages when the messages are written to the disk-buffer. That way, the client does not have to wait while the server acknowledges the messages.</para>
                </listitem>
            </itemizedlist>
        </section>
    </section>
    <section xml:id="rltp-options">
        <title><trademark>RLTP</trademark> options</title>
        <para>The following options are specific to the <trademark>RLTP</trademark> protocol. Note that when using <trademark>RLTP</trademark> in a source or a destination, the options of the <parameter>syslog()</parameter> or the <parameter>network()</parameter> driver can be used as well.</para>
        <xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="simplesect-allow.xml"/>
        <xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="simplesect-message.xml"/>
        <xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="simplesect-response.xml"/>
        <xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="simplesect-tls.xml"/>
    </section>
    <section xml:id="rltp-examples">
        <title>Examples for using <trademark>RLTP</trademark>
        </title>
        <example>
            <title>Simple <trademark>RLTP</trademark> connection</title>
            <para>The sender and the receiver use <trademark>RLTP</trademark> over the <parameter>network()</parameter> protocol. Since the <userinput>tls()</userinput> option is not configured neither on the sender nor on the receiver, the communication will be unencrypted.</para>
            <para><emphasis>Receiver configuration (&abbrev; server)</emphasis>:</para>
            <synopsis>source s_network_rltp {
        network(
            ip("127.0.0.1")
            port("5555")
            transport(rltp)
            ip-protocol(4)
        );
};</synopsis>
            <para><emphasis>Sender configuration (&abbrev; client)</emphasis>:</para>
            <synopsis>destination d_network_rltp {
        network(
            "127.0.0.1"
            port("5555")
            transport(rltp)
            ip-protocol(4)
        );
};</synopsis>
        </example>
        <example>
            <title><trademark>RLTP</trademark> with TLS encryption</title>
            <para>The following example configure a sender and a receiver to communicate using <trademark>RLTP</trademark>. Since the <parameter>tls-required()</parameter> option is set to <userinput>optional</userinput> on the receiver and <userinput>yes</userinput> on the sender, and the <parameter>tls()</parameter> option is configured, the communication will be TLS-encrypted. For the sender (&abbrev; client), reliable disk-buffering is enabled to prevent data loss.</para>
            <para><emphasis>Receiver configuration (&abbrev; server)</emphasis>:</para>
            <synopsis>source s_syslog_rltp {
        syslog(
            ip("127.0.0.1")
            port("4444")
            transport(rltp(tls-required(optional)))
            ip-protocol(4)
            tls(
                peer-verify(required-trusted)
                ca-dir("/var/tmp/client/")
                key-file("/var/tmp/server/server_priv.key")
                cert-file("/var/tmp/server/server.crt")
            )
        );
};</synopsis>
            <para><emphasis>Sender configuration (&abbrev; client)</emphasis>:</para>
            <synopsis>destination d_syslog_rltp {
        syslog(
            "127.0.0.1"
            port("4444")
            transport(rltp(tls-required(yes)))
            ip-protocol(4)
            disk-buffer( mem-buf-size(200000) disk-buf-size(2000000) reliable(yes) )
            tls(
                peer-verify(required-trusted)
                ca-dir("/var/tmp/server/")
                key-file("/var/tmp/client/client_priv.key")
                cert-file("/var/tmp/client/client.crt")
            )
        );
};</synopsis>
        </example>
    </section>
</chapter>
