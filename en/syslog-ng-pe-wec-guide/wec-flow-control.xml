<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE article
  [
  <!ENTITY % entities SYSTEM "../shared/syslog-ng-entities.ent">
  %entities;
  ]
 >
<section xml:id="wec-flow-control" xmlns="http://docbook.org/ns/docbook">
    <title>Flow control</title>
    <para>The &wec; tool applies flow control to minimize event log loss.</para>
    <para>&wecabbrev; regularly (in every second) polls the datagram socket that will receive the Windows events to check whether it exists already. Once the socket has been created (&abbrev; has started up), &wecabbrev; connects to the socket and accepts the incoming connections from the Windows hosts. If the datagram socket does not exist, &wecabbrev; refuses the incoming connections. </para>
    <para>If the socket exists (&abbrev; is running) but &abbrev; does not read the Unix datagram socket, &wecabbrev; fills up the kernel buffer of the datagram socket and stores <parameter>queuesize</parameter> amounts of log messages in the memory. When all buffers are full, &wecabbrev; stops reading messages from the HTTP connections to prevent message loss.</para>
    <para>The buffer size of a datagram socket is determined by certain Linux kernel parameters: the value of <userinput>rmem_*</userinput> (max/default) and the count of <userinput>net.unix.max_dgram_qlen</userinput>.</para>
    <simplesect>
        <title>Reliability</title>
        <para>&wecabbrev; flags a message as delivered once it has put the message in the socket buffer. If &abbrev; does not read the socket for some reason (for example, because it is still flow-controlled) and &abbrev; is stopped, the contents of this socket (that is, the messages that are in the kernel buffer, unread by &abbrev;) will be lost.</para>
        <para>This is why in cases when a restart is necessary, it is recommended to stop the &wec; and &abbrev; in the following order:</para>
        <orderedlist>
            <listitem>
                <para>&wec;</para>
            </listitem>
            <listitem>
                <para>&abbrev;</para>
            </listitem>
        </orderedlist>
        <para>While it is not guaranteed that &abbrev; has read all sockets by the time you stop it, at least you can maximize the chances that it has.</para>
    </simplesect>
</section>
