<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
<!ENTITY % entities SYSTEM "../../common/syslog-ng-entities.ent">
  %entities;]>
<chapter xml:id="chapter-filtering" xmlns="http://docbook.org/ns/docbook" version="5.0">
    <title>Filtering messages</title>
    <indexterm>
        <primary>message filtering</primary>
        <secondary>&agentabbrev;</secondary>
    </indexterm>
    <indexterm>
        <primary>&agentabbrev;</primary>
        <secondary>filtering messages</secondary>
    </indexterm>
    <para>The &agent; application can filter log messages both in blacklist- and whitelist fashion. When using blacklisting, you can define filters, and any message that matches the filters is ignored by the agent &mdash; only messages that do not match the filters are sent to the central server. When using whitelisting, you can define filters, and the messages matching the filters are forwarded to the central server &mdash; other messages are ignored. By default, blacklist filtering is used.</para>
    <para>If you define multiple filters, the messages must match every filter. In other words, the filters are connected to each other with logical AND operations.</para>
    <para>Different filters are available for eventlog- and file sources. When the &agentabbrev; processes a message, it checks the relevant filters one-by-one: for example if it finds a blacklist filter that matches the message, the agent stops processing the message without sending it to the server.</para>
    <note>
        <para>By default, all filters are case sensitive. For details on how to change this behavior, see <xref linkend="windows-global-settings"/>.</para>
    </note>
    <itemizedlist>
        <listitem>
            <para>For details on how to filter messages received from eventlog sources, see <xref linkend="filters-eventlog"/>.</para>
        </listitem>
        <listitem>
            <para>For details on how to filter messages received from file sources, see <xref linkend="filters-file"/>.</para>
        </listitem>
        <listitem>
            <para>For details on how to disable filtering globally, see <xref linkend="windows-disable-source"/>.</para>
        </listitem>
    </itemizedlist>
    <procedure xml:id="filters-eventlog">
        <title>Filtering eventlog messages</title>
        <indexterm>
            <primary>message filtering</primary>
            <secondary>eventlog messages</secondary>
        </indexterm>
        <formalpara>
            <title>Purpose:</title>
            <para/>
        </formalpara>
        <para>The following types of filters are available for eventlog sources. Unless described otherwise, the filters match only if the same string appears in the related field of the message.</para>
        <note>
            <para>When filtering on the message source, the values of the <guimenu>Source</guimenu> field can be incorrect in some cases. Check the <parameter>EVENT_SOURCE</parameter> field of a message to avoid any problems.</para>
        </note>
        <itemizedlist>
            <listitem>
                <para><emphasis>Sources</emphasis>: Filter on the source (application) that created the message. Corresponds with the <link linkend="EVENT-SOURCE"><parameter>EVENT_SOURCE</parameter></link> macro.</para>
            </listitem>
            <listitem>
                <para><emphasis>Sources and Event ID</emphasis>: Filter on the source (application) that created the message, and optionally on the identification number of the event. Corresponds with the <link linkend="EVENT-SOURCE"><parameter>EVENT_SOURCE</parameter></link> and <link linkend="EVENT-ID"><parameter>EVENT_ID</parameter></link> macros.</para>
            </listitem>
            <listitem>
                <para><emphasis>Message Contents</emphasis>: Filter the text of the message, that is, the contents of the <link linkend="EVENT-MESSAGE"><parameter>EVENT_MESSAGE</parameter></link> macro. In this filter you can use regular expressions.</para>
            </listitem>
            <listitem>
                <para><emphasis>Sources and Categories</emphasis>: Filter on the source (application) that created the message, and optionally on the category of the event. Corresponds with the <link linkend="EVENT-SOURCE"><parameter>EVENT_SOURCE</parameter></link> and <link linkend="EVENT-CATEGORY"><parameter>EVENT_CATEGORY</parameter></link> macros.</para>
                <example>
                    <title>Filtering on Sources and Categories</title>
                    <para>For example, you want to filter the following message:</para>
                    <synopsis>Source: Microsoft Windows security auditing
Category: Process Creation
New Process Name: C:\Windows\System32\SearchProtocolHost.exe</synopsis>
                    <para>Set the <guimenu>Source</guimenu> to <parameter>Microsoft Windows security auditing</parameter>, and <guimenu>Category</guimenu> to <parameter>Process Creation</parameter>.</para>
                </example>
            </listitem>
            <listitem>
                <para><emphasis>Users</emphasis>: Filter on the username associated with the event. Corresponds with the <link linkend="EVENT-USERNAME"><parameter>EVENT_USERNAME</parameter></link> macro.</para>
            </listitem>
            <listitem>
                <para><emphasis>Computers</emphasis>: Filter on the name of the computer (host) that created the event. Corresponds with the <link linkend="HOST"><parameter>HOST</parameter></link> macro.</para>
            </listitem>
            <listitem>
                <para><emphasis>Event Types</emphasis>: Filter on the type of the event. Corresponds with the <link linkend="EVENT-TYPE"><parameter>EVENT_TYPE</parameter></link> macro.</para>
            </listitem>
        </itemizedlist>
        <para>To modify the filters used for eventlog messages, complete the following procedure:</para>
        <formalpara>
            <title>Steps:</title>
            <para/>
        </formalpara>
        <step>
            <para>Start the configuration interface of the &agent; application.</para>
        </step>
        <step>
            <itemizedlist>
                <listitem>
                    <para>To apply filters globally to every eventlog message, select <guimenu>syslog-ng Agent Settings > Destinations > Global Event Filters</guimenu>, and right-click <guimenu>Global Event Filters</guimenu>.</para>
                </listitem>
                <listitem>
                    <para>To apply filters only to a specific destination, select <guimenu>syslog-ng Agent Settings > Destinations</guimenu>, select the destination server, then select <guimenu>Event Filters</guimenu>. Right-click <guimenu>Event Filters</guimenu>.</para>
                </listitem>
            </itemizedlist>
            <note>
                <para>If you want to use both global and local (server side) filtering, first global filters will be applied to the eventlog messages and then the local filters.</para>
            </note>
        </step>
        <step>
            <para>Select <guimenu>Properties > Enable > OK</guimenu>.</para>
            <figure>
                <title>Global event filters</title>
                <mediaobject>
                    <imageobject role="html">
                        <imagedata format="PNG" fileref="win-global-event-filters-properties.png"/>
                    </imageobject>
                    <imageobject role="fo">
                        <imagedata format="PNG" fileref="&imgroot;/win-global-event-filters-properties.png" contentwidth="10cm"/>
                    </imageobject>
                </mediaobject>
            </figure>
        </step>
        <step>
            <para>To use whitelist-filtering, select <guimenu>White List Filtering</guimenu>. By default, &agentabbrev; uses blacklist filtering.</para>
        </step>
        <step>
            <para>On the right-hand pane, double-click on the type of filter you want to create.</para>
        </step>
        <step>
            <itemizedlist>
<!-- FIXME linkeket a makrokra -->
                <listitem>
                    <para>To ignore messages sent by a specific application, or messages of the application with a specific event ID, double-click on <guimenu>Sources and Event ID</guimenu>, select <guimenu>Add</guimenu>, and select the name of the source (application) whose messages you want to ignore from the <guimenu>Source Name</guimenu> field. To ignore only specific messages of the application, enter the ID of the event into the <guimenu>Event ID</guimenu> field. Select <guimenu>Add > Apply</guimenu>.</para>
                    <figure>
                        <title>Sources and Event ID</title>
                        <mediaobject>
                            <imageobject role="html">
                                <imagedata format="PNG" fileref="win-sources-and-event-ids-properties.png"/>
                            </imageobject>
                            <imageobject role="fo">
                                <imagedata format="PNG" fileref="&imgroot;/win-sources-and-event-ids-properties.png" contentwidth="10cm"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                </listitem>
                <listitem>
                    <para>To ignore messages that contain a specific string or text, double-click on <guimenu>Message Contents</guimenu>, enter the search term or a POSIX regular expression into the <guimenu>Regular Expression</guimenu> field, then select <guimenu>Add > Apply</guimenu>.</para>
                    <figure>
                        <title>Message Contents</title>
                        <mediaobject>
                            <imageobject role="html">
                                <imagedata format="PNG" fileref="win-message-contents-properties.png"/>
                            </imageobject>
                            <imageobject role="fo">
                                <imagedata format="PNG" fileref="&imgroot;/win-message-contents-properties.png" contentwidth="10cm"/>
                            </imageobject>
                        </mediaobject>
                    </figure>
                </listitem>
                <listitem>
                    <para>To ignore messages sent by a specific application, or messages of the application that fall into a specific category, double-click on <guimenu>Sources and Categories</guimenu>, select <guimenu>Add</guimenu>, and select the name of the application whose messages you want to ignore from the <guimenu>Application Name</guimenu> field. To ignore only those messages of the application that fall into a specific category, enter the name of the category into the <guimenu>Category</guimenu> field. Select <guimenu>Add > Apply</guimenu>.</para>
                </listitem>
                <listitem>
                    <para>To ignore messages sent by a specific user, double-click on <guimenu>Users</guimenu>, enter the name of the user into the <guimenu>User</guimenu> field, then select <guimenu>Add > Apply</guimenu>.</para>
                </listitem>
                <listitem>
                    <para>To ignore messages sent by a specific computer (host), double-click on <guimenu>Computers</guimenu>, enter the name of the user into the <guimenu>Computer</guimenu> field, then select <guimenu>Add > Apply</guimenu>.</para>
                </listitem>
                <listitem>
                    <para><emphasis>Event Types</emphasis>: To ignore messages of a specific event-type, double-click on <guimenu>Event Types</guimenu>, select the event types to ignore, and select <guimenu>Ok > Apply</guimenu>.</para>
                    <note>
                        <para>Under Windows Vista and Server 2008, Windows labels certain messages as level 3 and the Event Viewer labels such messages as warnings. This is against the official specification: level 3 should not be used; and only level 2 messages are warnings. To filter these events, you have to manually add a new event type to the registry and set its value to 3, for example <parameter>HKEY_LOCAL_MACHINE\SOFTWARE\BalaBit\syslog-ng Agent\Local Settings\EventSources\Filter\Type\Rule0\Type=3</parameter></para>
                    </note>
                </listitem>
            </itemizedlist>
        </step>
        <step>
            <para>Select <guimenu>Apply</guimenu>, then <guimenu>OK</guimenu>. To activate the changes, restart the &agentabbrev; service.</para>
        </step>
    </procedure>
    <procedure xml:id="filters-file">
        <title>Filtering file messages</title>
        <indexterm>
            <primary>message filtering</primary>
            <secondary>file filters</secondary>
        </indexterm>
        <formalpara>
            <title>Purpose:</title>
            <para/>
        </formalpara>
        <para>The following types of filters are available for file sources:</para>
        <itemizedlist>
            <listitem>
                <para><emphasis>Message Contents</emphasis>: Filter the text of the message, that is, the contents of the <link linkend="FILE-MESSAGE"><parameter>FILE_MESSAGE</parameter></link> macro. In this filter you can use regular expressions.</para>
            </listitem>
            <listitem>
                <para><emphasis>File Name</emphasis>: Filter on the file name. Corresponds with the <link linkend="FILE-NAME"><parameter>FILE_NAME</parameter></link> macro. In this filter you can use wildcards (<parameter>*</parameter>, <parameter>?</parameter>). Only available for destination file filters.</para>
            </listitem>
        </itemizedlist>
        <para>To modify the filters used for file messages, complete the following procedure:</para>
        <formalpara>
            <title>Steps:</title>
            <para/>
        </formalpara>
        <step>
            <para>Start the configuration interface of the &agent; application.</para>
        </step>
        <step>
            <itemizedlist>
                <listitem>
                    <para>To apply filters globally to every file message, select <guimenu>syslog-ng Agent Settings > Destinations > Global File Filters</guimenu>, and right-click <guimenu>Global File Filters</guimenu>.</para>
                </listitem>
                <listitem>
                    <para>To apply filters only to a specific destination, select <guimenu>syslog-ng Agent Settings > Destinations</guimenu>, select the destination server, then select <guimenu>File Filters</guimenu>. Right-click <guimenu>File Filters</guimenu>.</para>
                </listitem>
            </itemizedlist>
            <note>
                <para>If you want to use both global and local (server side) filtering, first global filters will be applied to the file messages and then the local filters.</para>
            </note>
        </step>
        <step>
            <para>Select <guimenu>Properties > Enable > OK</guimenu>.</para>
            <figure>
                <title>Global file filters</title>
                <mediaobject>
                    <imageobject role="html">
                        <imagedata format="PNG" fileref="win-global-file-filters-properties.png"/>
                    </imageobject>
                    <imageobject role="fo">
                        <imagedata format="PNG" fileref="&imgroot;/win-global-file-filters-properties.png" contentwidth="10cm"/>
                    </imageobject>
                </mediaobject>
            </figure>
        </step>
        <step>
            <para>To use whitelist-filtering, select <guimenu>White List Filtering</guimenu>. By default, &agentabbrev; uses blacklist filtering.</para>
        </step>
        <step>
            <para>On the right-hand pane, double-click on the type of filter you want to create.</para>
        </step>
        <step>
            <itemizedlist>
                <listitem>
                    <para>To ignore messages that contain a specific string or text, double-click on <guimenu>Message Contents</guimenu>, enter the search term or a regular expression into the <guimenu>Regular Expression</guimenu> field, then select <guimenu>Add</guimenu>.</para>
                </listitem>
            </itemizedlist>
        </step>
        <step>
            <para>Select <guimenu>Apply</guimenu>, then <guimenu>OK</guimenu>. To activate the changes, restart the &agentabbrev; service.</para>
        </step>
    </procedure>
</chapter>
