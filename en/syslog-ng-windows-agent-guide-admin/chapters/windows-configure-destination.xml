<!DOCTYPE chapter
[
<!ENTITY % entities SYSTEM "../../shared/syslog-ng-entities.ent">
  %entities;]>
<procedure xml:id="windows-configure-destination" xmlns="http://docbook.org/ns/docbook">
    <title>Configuring the destination log servers</title>
    <formalpara>
        <title>Purpose:</title>
        <para/>
    </formalpara>
    <para>To configure a new destination, complete the following steps:</para>
    <formalpara>
        <title>Steps:</title>
        <para/>
    </formalpara>
    <step>
        <para>Start the configuration interface of the &agent; application.</para>
    </step>
    <step>
        <para>Select <guimenu>syslog-ng Agent Settings > Destinations</guimenu>, and double-click on <guimenu>Add new server</guimenu>.</para>
    </step>
    <step>
        <para>Enter the hostname or the IP address of the log server into the <guimenu>Server Name or Address (IPv4)</guimenu> field. If your log server is configured to accept messages on a non-standard port, type the port number into the <guimenu>Server Port</guimenu> field. To use the default port (<parameter>35514</parameter> when <trademark>RLTP</trademark> is enabled and <parameter>514</parameter> when <trademark>RLTP</trademark> is disabled), click <guimenu>Reset to Default Port</guimenu>.</para>
        <para>To enable flow-control, select <guimenu>Enable flow-control</guimenu>. For details, see <xref linkend="windows-agent-flow-control"/>.</para>
        <para>To use SSL encryption, enable <guimenu>Use SSL encryption</guimenu>. For details, see <xref linkend="chapter-ssl"/>.</para>
        <figure>
            <title>Adding new server</title>
            <mediaobject>
                <imageobject role="html">
                    <imagedata format="PNG" fileref="win-server-property-server.png"/>
                </imageobject>
                <imageobject role="fo">
                    <imagedata format="PNG" fileref="&imgroot;/win-server-property-server.png" contentwidth="10cm"/>
                </imageobject>
            </mediaobject>
        </figure>
    </step>
    <step>
        <para><emphasis>Optional Step</emphasis>: To use the <trademark>Reliable Log Transfer Protocol</trademark> (<trademark>RLTP</trademark>), enable <guimenu>Use syslog-ng proprietary Reliable Log Transfer Protocol (RLTP)</guimenu>. For details on the concepts of <trademark>RLTP</trademark>, see <olink targetdoc="syslog-ng-pe-guide-admin" targetptr="chapter-rltp"/>.</para>
        <xi:include href="../../shared/wnt/note-windows-agent-rltp-flowcontrol.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
        <substeps>
            <xi:include href="../../shared/chunk/step-agent-allow-compress.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
            <step>
                <para>Change the following options if necessary:</para>
                <note>
                    <para>Do not adjust or modify the following settings unless you know exactly what you are doing.</para>
                </note>
                <itemizedlist>
                    <listitem>
                        <para><guimenu>Transaction Size</guimenu>: The number of messages sent before waiting for acknowledgement from the server.</para>
                    </listitem>
                    <listitem>
                        <para><guimenu>Response Timeout</guimenu>: After not receiving any message in the given timeframe, &agentabbrev; terminates the connection with the server.</para>
                    </listitem>
                    <listitem>
                        <para><guimenu>Acknowledge Timeout</guimenu>: After not receiving any reply to the messages in the given timeframe, &agentabbrev; terminates the connection with the server.</para>
                    </listitem>
                </itemizedlist>
            </step>
            <step>
                <para>Click <guimenu>OK</guimenu>.</para>
            </step>
        </substeps>
    </step>
    <step>
        <para>On <guimenu>Messages</guimenu> tab, select the protocol used to transfer log messages and press <guimenu>Reset</guimenu> to apply the selected template. The following protocol templates are available (for details on the default templates and on customizing the message format, see <xref linkend="chapter-format"/>):</para>
        <itemizedlist>
            <listitem>
                <indexterm>
                    <primary>BSD-syslog protocol</primary>
                </indexterm>
                <indexterm>
                    <primary>Legacy-syslog protocol</primary>
                </indexterm>
                <indexterm>
                    <primary>RFC 3164</primary>
                </indexterm>
                <para><guimenu>Legacy BSD Syslog Protocol</guimenu>: Use the legacy BSD-syslog protocol specified in RFC3164. This option uses the following message template: <parameter>&lt;${PRI}&gt;${BSDDATE} ${HOST} ${MSGHDR}${MESSAGE}</parameter>. Within the message part, &agentabbrev; replaces CRLF with 2 spaces and TAB character with 1 space.</para>
                <figure>
                    <title>Legacy BSD Syslog Protocol</title>
                    <mediaobject>
                        <imageobject role="html">
                            <imagedata format="PNG" fileref="win-legacy-bsd-syslog-protocol.png"/>
                        </imageobject>
                        <imageobject role="fo">
                            <imagedata format="PNG" fileref="&imgroot;/win-legacy-bsd-syslog-protocol.png" contentwidth="10cm"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <example xml:id="example-legacy-bsd">
                    <title>Legacy BSD Syslog Protocol log</title>
                    <synopsis>&lt;134&gt;Oct 04 14:45:33 zts-win019.ztswin2008dom.balabit Microsoft-Windows-Eventlog[2880]: ZTSWIN2008DOM\balabit: System Microsoft-Windows-Eventlog: [Information] The Application log file was cleared. (EventID 104)</synopsis>
                </example>
            </listitem>
            <listitem>
                <indexterm>
                    <primary>syslog protocol</primary>
                </indexterm>
                <indexterm>
                    <primary>IETF-syslog protocol</primary>
                </indexterm>
                <indexterm>
                    <primary>RFC 5424-5426</primary>
                </indexterm>
                <para><guimenu>Syslog Protocol</guimenu>: Use the new IETF-syslog protocol specified in <link xmlns:ns1="http://www.w3.org/1999/xlink" ns1:href="https://tools.ietf.org/html/rfc5424">RFC 5424-5426</link>. This is the default setting.</para>
                <figure>
                    <title>Syslog Protocol</title>
                    <mediaobject>
                        <imageobject role="html">
                            <imagedata format="PNG" fileref="win-syslog-protocol.png"/>
                        </imageobject>
                        <imageobject role="fo">
                            <imagedata format="PNG" fileref="&imgroot;/win-syslog-protocol.png" contentwidth="10cm"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <indexterm>
                    <primary>SDATA</primary>
                </indexterm>
                <indexterm>
                    <primary>sending macros in SDATA</primary>
                </indexterm>
                <indexterm>
                    <primary>metadata in SDATA</primary>
                </indexterm>
                <indexterm>
                    <primary>IETF-syslog protocol</primary>
                    <secondary>SDATA</secondary>
                </indexterm>
                <indexterm>
                    <primary>IETF-syslog protocol</primary>
                    <secondary>adding macros to SDATA</secondary>
                </indexterm>
                <!-- FIXME we should find a better place for this info, or structure the procedure differently -->
                <para>When using the IETF-syslog protocol to transfer Eventlog messages, the &agentabbrev; application includes the macros (name-value pairs) in the SDATA part of the log message by default. This includes every available Event macro, except <parameter>EVENT_MSG (EVENT_MESSAGE)</parameter>, <parameter>EVENT_MSG_XML (EVENT_MESSAGE_XML)</parameter>. Macros that do not have a value will not be included in the message.</para>
                <synopsis>499 &lt;132&gt;1 2010-09-28T12:02:30+02:00 zts-win004.ztswin2003dom.balabit testapp 1220 - [win@18372.4 EVENT_ID="1000" EVENT_NAME="Application" EVENT_REC_NUM="1673" EVENT_SID="S-1-5-21-3460971693-970282485-2299281428-1001" EVENT_SID_TYPE="User" EVENT_SOURCE="testapp" EVENT_TYPE="Warning" EVENT_USERNAME="ZTS-WIN004\\balabit"][meta sequenceId="1" sysUpTime="1"] ï»¿ZTS-WIN004\balabit: Application testapp: [Warning] test message (EventID 1000)</synopsis>
                <note>
                    <para>The names of SDATA fields must be in the following format: name@&lt;private enterprise number&gt;, for example, <parameter>mySDATA-field@18372.4</parameter>. (18372.4 is the private enterprise number of BalaBit IT Security, the developer of &agent;.)</para>
                    <itemizedlist>
                        <listitem>
                            <para>Messages received from eventlog sources include the <parameter>win@18372.4</parameter> SD-ID. For example, on your &abbrev; server you can refer to message fields like: <parameter>${.SDATA.win@18372.4.EVENT_SOURCE}</parameter></para>
                        </listitem>
                        <listitem>
                            <para>Messages received from file sources include the <parameter>file@18372.4</parameter> SD-ID. For example, on your &abbrev; server you can refer to message fields like: <parameter>${.SDATA.file@18372.4.name}</parameter></para>
                        </listitem>
                    </itemizedlist>
                </note>
                <para>To include only the data mandated by RFC5424, disable <guimenu>Include Eventlog message metadata as SDATA</guimenu>. To do this, navigate to <guimenu>Destinations > Destination Global Settings</guimenu>, select <guimenu>Enable</guimenu> and deselect <guimenu>Include Eventlog message metadata as SDATA</guimenu>. For example, only the following data will be included in the message:</para>
                <synopsis>[meta sequenceId="value" sysUpTime="value"]</synopsis>
            </listitem>
            <listitem>
                <indexterm>
                    <primary>snare</primary>
                </indexterm>
                <para><guimenu>Snare Protocol</guimenu>: Send log messages in a format compatible with the Snare log monitoring tool.</para>
                <figure>
                    <title>Snare Protocol</title>
                    <mediaobject>
                        <imageobject role="html">
                            <imagedata format="PNG" fileref="win-snare-protocol.png"/>
                        </imageobject>
                        <imageobject role="fo">
                            <imagedata format="PNG" fileref="&imgroot;/win-snare-protocol.png" contentwidth="10cm"/>
                        </imageobject>
                    </mediaobject>
                </figure>
                <note>
                    <para>Snare is a tab-separated message format. Within the message part, agent replaces CRLF with 2 space, TAB character with 1 space.</para>
                    <para>You cannot modify the log format if you have selected this protocol.</para>
                </note>
                <example xml:id="example-snare-log">
                    <title>Snare log</title>
                    <synopsis>&lt;134&gt;Oct 06 13:49:41 zts-win019.ztswin2008dom.balabit MSWinEventLog   1   Application 1   Wed Oct 06 13:49:41 2010    1   syslog-ng Agent   S-1-5-21-551780264-1021859348-3425375765-1003   User    Information zts-win019.ztswin2008dom.balabit    None        Application started 1</synopsis>
                </example>
            </listitem>
        </itemizedlist>
        <note>
            <para>Selecting the <guimenu>Syslog Protocol</guimenu> option is identical to using the <parameter>syslog</parameter> driver in the Linux/Unix version of syslog-ng. Similarly, selecting <guimenu>Legacy BSD Syslog Protocol</guimenu> is equivalent to the <parameter>tcp</parameter> driver of syslog-ng.</para>
            <para>Changing to the <guimenu>Legacy BSD Protocol</guimenu> does not automatically restore the original template. To do so, click <guimenu>Reset Protocol Template</guimenu> after modifying the protocol.</para>
        </note>
    </step>
    <step>
        <indexterm>
            <primary>message template</primary>
        </indexterm>
        <indexterm>
            <primary>message format</primary>
        </indexterm>
        <indexterm>
            <primary>formatting messages</primary>
        </indexterm>
        <para>If needed, modify the template of the messages. The format of the messages can be different for the eventlog and the file sources.</para>
        <warning>
            <para>The maximal length of the template is 1023 characters.</para>
        </warning>
    </step>
    <step>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>failover servers</secondary>
        </indexterm>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>client-side failover</secondary>
        </indexterm>
        <indexterm>
            <primary>client-side failover</primary>
            <secondary>&agentabbrev;</secondary>
        </indexterm>
        <para>If you have a backup server that can accept log messages if the primary log server becomes unavailable, select the <guimenu>Failover Servers</guimenu> tab, click <guimenu>Add</guimenu>, and enter the hostname or the IP address of the backup log server into the <guimenu>Server Name</guimenu> field. Repeat this step if you have more than one backup servers.</para>
        <figure>
            <title>Failover Servers</title>
            <mediaobject>
                <imageobject role="html">
                    <imagedata format="PNG" fileref="win-server-property-failover.png"/>
                </imageobject>
                <imageobject role="fo">
                    <imagedata format="PNG" fileref="&imgroot;/win-server-property-failover.png" contentwidth="10cm"/>
                </imageobject>
            </mediaobject>
        </figure>
    </step>
    <step>
        <para>If you want to send the log messages to more than on server in parallel, so that every server receives every message, repeat Steps 3-4 to add the other destination servers. These servers may have failover servers as well.</para>
    </step>
    <step>
        <para>Select <guimenu>Apply</guimenu>, then <guimenu>OK</guimenu>. To activate the changes, restart the &agentabbrev; service.</para>
    </step>
    <step>
        <indexterm>
            <primary>hostname resolution</primary>
        </indexterm>
        <indexterm>
            <primary>hostname in the messages</primary>
        </indexterm>
        <para><emphasis>Optional Step</emphasis>: If the host running &agentabbrev; is sometimes logged in into a domain, sometimes not, then its hostname might change depending on its actual domain membership. This can cause that the hostname appearing in the syslog messages depends on the domain membership of the host. To avoid this situation, select <guimenu>syslog-ng Agent Settings > Global Settings > Hostname > Use FQDN</guimenu>. That way &agentabbrev; resolves the name of its host from the DNS server, and uses the resolved FQDN in the syslog messages.</para>
    </step>
</procedure>
