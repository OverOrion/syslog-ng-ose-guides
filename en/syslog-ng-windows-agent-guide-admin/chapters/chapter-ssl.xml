<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
<!ENTITY % entities SYSTEM "../../common/syslog-ng-entities.ent">
  %entities;]>
<chapter xml:id="chapter-ssl" xmlns="http://docbook.org/ns/docbook" version="5.0">
    <title>Using SSL-encrypted connections with the &agentabbrev;</title>
    <indexterm>
        <primary>authentication</primary>
        <secondary>&agentabbrev;</secondary>
    </indexterm>
    <indexterm>
        <primary>TLS</primary>
        <secondary>&agentabbrev;</secondary>
    </indexterm>
    <indexterm>
        <primary>certificates</primary>
    </indexterm>
    <para>When connecting to a syslog-ng server using an encrypted connection, the &agent; verifies the certificate of the server. The connection can be established only if the &agent; can verify the certificate of the syslog server. For this, import one of the following certificates into the Certificate Store (<guimenu>MMC > Certificates > Computer Account > Local Computer > Trusted Root Certificates</guimenu>) of the Windows-based host:</para>
    <itemizedlist>
        <listitem>
            <para>The certificate of the Certificate Authority (CA) that issued the certificate of the server</para>
        </listitem>
        <listitem>
            <para>If your server uses a self-signed certificate, import the self-signed certificate</para>
        </listitem>
    </itemizedlist>
    <para>For details on importing certificates, see <xref linkend="windows-importcert"/>.</para>
    <note>
        <para>This certificate (sometimes also called the CACert of the server) is not the certificate of the server: it is the certificate of the CA that signed the certificate of the server.<!-- (For details on how certificate-based authentication
            works, see <xref linkend="concepts-tls"/>)--></para>
    </note>
    <procedure xml:id="windows-enable-ssl">
        <title>Enabling encrypted connections</title>
        <formalpara>
            <title>Purpose:</title>
            <para/>
        </formalpara>
        <para>To enable SSL-encrypted connections to the server, complete the following steps:</para>
        <formalpara>
            <title>Steps:</title>
            <para/>
        </formalpara>
        <step>
            <para>Start the configuration interface of the &agent; application.</para>
        </step>
        <step>
            <para>Select <guimenu>syslog-ng Agent Settings > Destinations</guimenu>.</para>
        </step>
        <step>
            <para>Right-click on the server that accepts encrypted connections and select <guimenu>Properties</guimenu>.</para>
        </step>
        <step>
            <para>Select the <guimenu>Use SSL</guimenu> option.</para>
            <warning>
                <para>The connection is established only if the &agent; can verify the certificate of the syslog server. For this, import one of the following certificates into the Certificate Store (<guimenu>MMC > Certificates > Computer Account > Local Computer > Trusted Root Certificates</guimenu>) of the Windows-based host:</para>
                <itemizedlist>
                    <listitem>
                        <para>The certificate of the Certificate Authority (CA) that issued the certificate of the server</para>
                    </listitem>
                    <listitem>
                        <para>If your server uses a self-signed certificate, import the self-signed certificate</para>
                    </listitem>
                </itemizedlist>
                <para>For details on importing certificates, see <xref linkend="windows-importcert"/>.</para>
            </warning>
            <xi:include href="../../common/wnt/note-cert-common-name.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
        </step>

        <xi:include href="../../common/chunk/step-agent-allow-compress.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>

        <step>
            <para>Select <guimenu>Apply</guimenu>, then <guimenu>OK</guimenu>. To activate the changes, restart the &agentabbrev; service.</para>
        </step>
    </procedure>
    <section xml:id="windows-ssl-mutual">
        <title>Using mutual authentication with &agentabbrev;</title>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>mutual authentication</secondary>
        </indexterm>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>client authentication</secondary>
        </indexterm>
        <indexterm>
            <primary>mutual authentication</primary>
            <secondary>&agentabbrev;</secondary>
        </indexterm>
        <indexterm>
            <primary>client authentication</primary>
            <secondary>&agentabbrev;</secondary>
        </indexterm>
        <para>When the syslog-ng server is configured to use mutual authentication, it requests a certificate from the syslog-ng clients. The &agentabbrev; application can automatically show the requested certificate to the server when the connection is established, provided it is available in the <guimenu>Personal Certificates</guimenu> store (<guimenu>MMC > Certificates > Computer Account > Local Computer > Personal Certificates</guimenu>) of the Local Computer. Use the <guimenu>Certificate Import Wizard</guimenu> to import this certificate. For details, see <xref linkend="windows-importcert"/>.</para>
<!--      <note>
            <para>If the syslog-ng agent cannot find a suitable certificate in the Local
            Computer/Personal Certificates store, it also checks the Personal Certificates
            store of the syslog-ng Agent service. If the syslog-ng agent was started
            manually, the Personal Certificates store of the current user is also
            checked.</para>
            </note>-->
        <note>
            <indexterm>
                <primary>&agentabbrev;</primary>
                <secondary>certificate revocation lists</secondary>
            </indexterm>
            <indexterm>
                <primary>&agentabbrev;</primary>
                <secondary>CRL</secondary>
            </indexterm>
            <indexterm>
                <primary>certificate revocation lists</primary>
                <secondary>&agentabbrev;</secondary>
            </indexterm>
            <indexterm>
                <primary>CRL</primary>
                <secondary>&agentabbrev;</secondary>
            </indexterm>
            <para>If a certificate revocation list (CRL) is available in the Local Computer/Personal Certificates store, the &agentabbrev; verifies that the certificate of the syslog-ng server is not on this list.</para>
        </note>
        <procedure xml:id="proc-windows-ssl-mutual">
            <title>Configuring mutual authentication with the &agentabbrev; for Windows</title>
            <formalpara>
                <title>Purpose:</title>
                <para/>
            </formalpara>
            <para>If the syslog-ng server requests authentication from the &agentabbrev;, complete the following steps.</para>
            <formalpara>
                <title>Steps:</title>
                <para/>
            </formalpara>
            <step>
                <para>Create certificates for the clients. By default, the &agentabbrev; will look for a certificate that contains the hostname or IP address of the central syslog-ng server in its Common Name. If you use a different Common Name, do not forget to complete Step 3 to set the Common Name of the certificate.</para>
                <para>The certificate must contain the private key and must be in PKCS12 format.</para>
                <tip>
                    <para>To convert a certificate and a key from PEM format to PKCS12 you can use the following command:</para>
                    <synopsis>openssl pkcs12 -export -in agentcertificate.pem -inkey agentprivatekey.pem -out agentcertificatewithkey.pfx </synopsis>
                </tip>
            </step>
            <step>
                <para>Import this certificate into the <guimenu>Personal Certificate</guimenu> store of the Local Computer using the Certificate Import Wizard. For details, see <xref linkend="windows-importcert"/>.</para>
            </step>
            <step>
                <para>By default, the &agentabbrev; will look for a certificate that contains the hostname or IP address of the central syslog-ng server in its Common Name. (The agent will look for the server name or address set in the <guimenu>Server Name</guimenu> field of the destination.) If the certificate of the client has a different Common Name, complete the following steps:</para>
                <substeps>
                    <step>
                        <para>Start the configuration interface of the &agentabbrev; for Windows application.</para>
                    </step>
                    <step>
                        <para>Select <guimenu>syslog-ng Agent Settings > Destinations</guimenu>.</para>
                    </step>
                    <step>
                        <para>Right-click on the server that requires mutual authentication and select <guimenu>Properties</guimenu>.</para>
                    </step>
                    <step>
                        <para>Select the <guimenu>Use SSL</guimenu> option, click <guimenu>Select</guimenu>, then select the certificate to use. You can also type the Common Name of the certificate into the <guimenu>Client Certificate Subject</guimenu> field.</para>
                        <para>If you have more than one certificates with the same Common Name, alternatively, you can type the Distinguished Name (DN) of the certificate into the <guimenu>Client Certificate Subject</guimenu> field. When using the Distinguished Name, type only the elements of the name, separated with comma, starting with the country. For example <parameter>US, Maryland, Pasadena, Example Inc, Sample Department, mycommonname</parameter></para>
                        <note>
                            <para>A common way is to use the hostname or the IP address of the host running the &agentabbrev; as the Common Name of the certificate (for example <parameter>syslog-ng-agent1.example.com</parameter>).</para>
                        </note>
                    </step>
                </substeps>
            </step>
            <step>
                <para>Select <guimenu>Apply</guimenu>, then <guimenu>OK</guimenu>. To activate the changes, restart the &agentabbrev; service.</para>
            </step>
        </procedure>
    </section>
    <procedure xml:id="windows-importcert">
        <title>Importing certificates with the Microsoft Management Console</title>
        <indexterm>
            <primary>certificates</primary>
            <secondary>importing on Windows</secondary>
        </indexterm>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>importing certificates</secondary>
        </indexterm>
        <indexterm>
            <primary>importing certificates</primary>
        </indexterm>
        <formalpara>
            <title>Purpose:</title>
            <para/>
        </formalpara>
        <para>To import a certificate, complete the following steps.</para>
<!-- FIXME leirni, hogy a Ca es kliens certeket hogyan lehet domain controllerbol
            letolni a kliensekre
            CA: GPO > properties > edit > Windows Settings > Publi key policies > Trusted Root Certificates > Import
        -->
        <formalpara>
            <title>Steps:</title>
            <para/>
        </formalpara>
        <step>
            <para>Start Microsoft Management Console by executing <filename>mmc.exe</filename> (<guimenu>Start</guimenu> menu <guimenu>Run application</guimenu>).</para>
            <note>
                <para>Running <filename>mmc.exe</filename> requires administrator privileges.</para>
            </note>
        </step>
        <step>
            <para>Click on the <guimenu>Add/Remove snap-in</guimenu> item of the <guimenu>File</guimenu> menu.</para>
        </step>
        <step>
            <para>Click <guimenu>Add</guimenu>, select the <guimenu>Certificates</guimenu> module, and click <guimenu>Add</guimenu>.</para>
        </step>
        <step>
            <para>Select <guimenu>Computer account</guimenu> in the displayed window and click <guimenu>Next</guimenu>.</para>
        </step>
        <step>
            <para>Select <guimenu>Local computer</guimenu> and click <guimenu>Close</guimenu>.</para>
        </step>
        <step>
            <para>To import the CA certificate of the syslog-ng server's certificate, navigate to <guimenu>Console Root > Certificates > Trusted Root Certificate Authorities > Certificates</guimenu>.</para>
            <para>To import a certificate for the &agentabbrev; to perform mutual authentication, navigate to <guimenu>Console Root > Certificates > Personal > Certificates</guimenu>.</para>
        </step>
        <step>
            <para>Right-click on the <guimenu>Certificates</guimenu> folder and from the appearing menu select <guimenu>All tasks > Import</guimenu>. The <guimenu>Certificate Import Wizard</guimenu> will be displayed. Click <guimenu>Next</guimenu>.</para>
            <para><emphasis>Optional step</emphasis>: Certificates used to authenticate the &agentabbrev; in mutual authentication include the private key. Provide the password for the private key when requested.</para>
        </step>
        <step>
            <para>Windows offers a suitable certificate store by default, so click <guimenu>Next</guimenu>.</para>
        </step>
        <step>
            <para>Click <guimenu>Finish</guimenu> on the summary window and <guimenu>Yes</guimenu> on the window that marks the successful importing of the certificate.</para>
        </step>
    </procedure>
</chapter>
