<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
<!ENTITY % entities SYSTEM "../../common/syslog-ng-entities.ent">
  %entities;]>
<chapter xml:id="chapter-sources" xmlns="http://docbook.org/ns/docbook" version="5.0">
    <title>Configuring message sources</title>
    <para>The &agent; application can read messages from eventlog containers and text files. The following sections explain how to configure these message sources.</para>
    <itemizedlist>
        <listitem>
            <para>For details on how to forward messages from eventlog containers, see <xref linkend="windows-sources-eventlog"/>.</para>
        </listitem>
        <listitem>
            <para>For details on how to forward messages from plain text log files, see <xref linkend="windows-sources-file"/>.</para>
        </listitem>
        <listitem>
            <para>Some global settings can apply to both types of sources, these are described in <xref linkend="windows-global-settings"/>.</para>
        </listitem>
    </itemizedlist>

    <xi:include href="windows-eventlog.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>

    <procedure xml:id="windows-sources-file">
        <title>Managing file sources</title>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>file sources</secondary>
        </indexterm>
        <indexterm>
            <primary>sources</primary>
            <secondary>windows log files</secondary>
        </indexterm>
        <formalpara>
            <title>Purpose:</title>
            <para/>
        </formalpara>
        <para>The &agent; application can collect log messages from text files. It can process messages spanning multiple lines, and supports the use of wildcards (<parameter>*</parameter>, <parameter>?</parameter>) in filenames to be able to follow log files that are automatically rotated. Note that every line of the file that ends with a newline character is considered a separate message. However, if a file contains only a single line that does not end with a newline character, &agentabbrev; will not process the line.</para>
        <para>To configure file sources, complete the following steps:</para>
        <xi:include href="../../common/wnt/warning-windows-network-shares.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
        <warning>
            <para>If an application deletes a log file, the application must ensure that &agentabbrev; had enough time to forward the messages from the file to the central server to avoid losing messages.</para>
        </warning>
        <example>
            <title xml:id="example-collecting-multiple">Collecting the logs of multiple applications from a single folder</title>
            <para>If two applications log into the same folder (for example <filename>C:\logs</filename>), you have to create two file sources. For example, if the name of the log files is <parameter>application1-*.log</parameter> and <parameter>application2-*.log</parameter>, respectively, then create two file sources with the <filename>C:\logs</filename> Base Directory, but with different File Name Filter: <parameter>application1-*.log</parameter> and <parameter>application2-*.log</parameter>, respectively.</para>
            <para>If other applications log into the <filename>C:\logs</filename> folder, add a separate expression for each application.</para>
            <para>By default, the &agentabbrev; will send every message to the server that arrives into any of the monitored log files.</para>
        </example>
        <figure>
            <title>Managing file sources</title>
            <mediaobject>
                <imageobject role="html">
                    <imagedata format="PNG" fileref="win-file-source-property.png"/>
                </imageobject>
                <imageobject role="fo">
                    <imagedata format="PNG" fileref="&imgroot;/win-file-source-property.png" contentwidth="10cm"/>
                </imageobject>
            </mediaobject>
        </figure>
        <figure>
            <title>Sources properties</title>
            <mediaobject>
                <imageobject role="html">
                    <imagedata format="PNG" fileref="win-sources-properties.png"/>
                </imageobject>
                <imageobject role="fo">
                    <imagedata format="PNG" fileref="&imgroot;/win-sources-properties.png" contentwidth="10cm"/>
                </imageobject>
            </mediaobject>
        </figure>
        <formalpara>
            <title>Steps:</title>
            <para/>
        </formalpara>
        <step>
            <para>Start the configuration interface of the &agent; application.</para>
        </step>
        <step>
            <para>Select <guimenu>syslog-ng Agent Settings > File Sources</guimenu>, double-click on <guimenu>Sources</guimenu>, and check the <guimenu>Enable</guimenu> option.</para>
        </step>
        <step>
            <para>Select <guimenu>Add > Browse</guimenu>, and select the folder containing the log files in the <guimenu>Base Directory</guimenu> field. Select or enter the name and extension of the log files in the <guimenu>File Name Filter</guimenu> field. Wildcards can be used. The &agentabbrev; will forward log messages from every file that is located in this folder and has a name that matches the filter expression.</para>
            <xi:include href="../../common/wnt/warning-windows-network-shares.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
            <tip>
                <para>When specifying the Base Directory, you can use the environment variables of Windows, for example <parameter>%WINDIR%</parameter>, <parameter>%SYSTEMROOT%</parameter>, <parameter>%PROGRAMFILES%</parameter>, and so on.</para>
            </tip>
            <warning>
                <para>Note that when managing members of a domain, the selected path must be available on the domain members, for example <filename>C:\logs</filename> must be available on the client hosts and not on the domain controller.</para>
            </warning>
        </step>
        <step>
            <itemizedlist>
                <listitem>
                    <para>To send messages from the files located in the subfolders of the folder set as Base Directory, select the <guimenu>Recursive</guimenu> option.</para>
                </listitem>
                <listitem>
                    <para>To change the log facility or the log severity associated to the file source, select the desired facility or priority from the <guimenu>Log Facility</guimenu> or <guimenu>Log Severity</guimenu> fields, respectively.</para>
                    <note>
                        <para>Significant changes to the settings of a file source can cause the &agentabbrev; to resend the entire contents of the matching files. This means that log messages already sent earlier to the syslog-ng server may be resent and thus duplicated in the server logs. Configuration changes that can result in such behavior are:</para>
                        <itemizedlist>
                            <listitem>
                                <para>changing the Base Directory,</para>
                            </listitem>
                            <listitem>
                                <para>changing filter options,</para>
                            </listitem>
                            <listitem>
                                <para>changing the Recursive option.</para>
                            </listitem>
                        </itemizedlist>
                    </note>
                </listitem>
            </itemizedlist>
        </step>
        <step>
            <para><emphasis>Optional Step</emphasis>: By default, the &agentabbrev; application starts sending messages from the beginning of the file. If you only want to send the messages that are newly added to the file, deselect the <guimenu>Read Old Records</guimenu> option.</para>
            <note>
                <para>Be careful when <guimenu>Read Old Records</guimenu> is disabled. If a new file(s) is created while &agentabbrev; is stopped, the content of this file will not be forwarded, only the new records. To avoid message loss, never disable <guimenu>Read Old Records</guimenu> in the configuration.</para>
            </note>
        </step>
        <step xml:id="windows-sources-file-encoding">
            <indexterm>
                <primary>file sources</primary>
                <secondary>encoding</secondary>
            </indexterm>
            <indexterm>
                <primary>file encoding</primary>
            </indexterm>
            <para>By default, the &agentabbrev; application assumes that the source files are encoded using the default windows ANSI code page, specific to the locale of the host. If the files have a different encoding, select it from the <guimenu>File Encoding</guimenu> field. Note that the log messages are sent to the destinations using UTF-8 encoding.</para>
        </step>
        <step xml:id="windows-sources-file-multi-line" xreflabel="Processing multi-line messages">
            <indexterm>
                <primary>processing multi-line messages</primary>
            </indexterm>
            <indexterm>
                <primary>multi-line messages</primary>
            </indexterm>
            <indexterm>
                <primary>multiline messages</primary>
            </indexterm>
            <para>If a log messages in the log file consists of multiple lines, that is, the log messages contain newline characters, configure &agentabbrev; to process the related lines as a single message.</para>
            <indexterm>
                <primary>Tomcat log messages</primary>
            </indexterm>
            <indexterm>
                <primary>Catalina log messages</primary>
            </indexterm>
            <indexterm>
                <primary>Apache Tomcat Catalina log messages</primary>
            </indexterm>
            <indexterm>
                <primary>Oracle SQL log messages</primary>
            </indexterm>
            <para>The &agentabbrev; application can automatically handle Apache Tomcat Catalina and Oracle SQL log messages. To process such messages, select the name of the application from the <guimenu>Multiple Lines > Application</guimenu> field. Note that the timestamp of Tomcat log messages depends on the locale of the host. The &agent; application automatically removes the last CRLF control character from multi-line messages.</para>
            <para>To process multi-line log messages of a different application, complete the following steps.</para>
            <substeps>
                <step>
                    <para>Select <guimenu>Multiple Lines > Application > Custom</guimenu>, and set the <guimenu>Multiple Lines > Prefix</guimenu> and optionally the <guimenu>Multiple Lines > Garbage</guimenu> fields.</para>
                </step>
                <step>
                    <indexterm type="parameter">
                        <primary>multi-line-prefix()</primary>
                    </indexterm>
                    <para>Specify a string or regular expression that matches the beginning of the log messages in the <guimenu>Multiple Lines > Prefix</guimenu> field. If the <guimenu>Prefix</guimenu> option is set, the &agentabbrev; ignores newline characters from the source until a line matches the regular expression again, and treats the lines between the matching lines as a single message.</para>
                    <note>
                        <para>Use as simple regular expressions as possible, because complex regular expressions can severely reduce the rate of processing multi-line messages.</para>
                    </note>
                </step>
                <step>
                    <para>Use the <guimenu>Multiple Lines > Garbage</guimenu> option when processing multi-line messages that contain unneeded parts between the messages. Specify a string or regular expression that matches the beginning of the unneeded message parts. If the <guimenu>Garbage</guimenu> option is set, the &agentabbrev; ignores lines between the line matching the <guimenu>Garbage</guimenu> expression and the next line matching <guimenu>Prefix</guimenu>.</para>
                    <para>When receiving multi-line messages from a source when the <guimenu>Garbage</guimenu> option is set but no matching line is received between two lines that match <guimenu>Prefix</guimenu>, the &agentabbrev; application will continue to process the incoming lines as a single message until a line matching <guimenu>Garbage</guimenu> is received.</para>
                    <warning>
                        <para>If the <guimenu>Garbage</guimenu> option is set, the &agentabbrev; application discards lines between the line matching the <guimenu>Garbage</guimenu> and the next line matching <guimenu>Prefix</guimenu> expressions.</para>
                    </warning>
                </step>
                <step>
                    <para><emphasis>Optional Step</emphasis>: After creating and testing a custom pattern, please consider sending your pattern to &vendor; so we can include it in a future version of &agentabbrev;. To share your pattern with &vendor; and other &agentabbrev; users, click <guimenu>Multiple Lines > Send custom pattern to BalaBit</guimenu>. Your e-mail application will open, with an e-mail containing the application name and the pattern.</para>
                </step>
            </substeps>
        </step>
        <step>
            <para>Select <guimenu>Apply</guimenu>, then <guimenu>OK</guimenu>. To activate the changes, restart the &agentabbrev; service.</para>
        </step>
    </procedure>

    <procedure xml:id="windows-sources-internal">
        <title>Managing the internal source</title>
        <indexterm>
            <primary>sources</primary>
            <secondary>internal</secondary>
        </indexterm>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>internal source</secondary>
        </indexterm>
        <indexterm>
            <primary>internal source</primary>
        </indexterm>
        <formalpara>
            <title>Purpose:</title>
            <para/>
        </formalpara>
        <para>All messages generated internally by &agent; application use the internal source. The &agent; application can forward messages originating from the internal source to certain destinations. To configure the internal source, complete the following steps:</para>
        <formalpara>
            <title>Steps:</title>
            <para/>
        </formalpara>
        <step>
            <para>Select <guimenu>syslog-ng Agent Settings</guimenu> and double-click on <guimenu>Global Settings</guimenu>.</para>
        </step>
        <step>
            <para>Enable <guimenu>Global Settings</guimenu>.</para>
        </step>
        <step>
            <para>Navigate to <guimenu>Internal Messages</guimenu>.</para>
        </step>
        <step>
            <para>Select the internal message types to forward to the <guimenu>Application event container</guimenu>, or to <guimenu>Remote destinations</guimenu> (meaning all servers that are configured as normal TCP destinations). The message types correspond to the respective message severities. The default setting is internal error and warning messages forwarded to <guimenu>Application event container</guimenu>, and info messages forwarded to <guimenu>Remote destinations</guimenu>.</para>
            <para>Only the selected message types will be forwarded.</para>
            <warning>
                <para>If the same message types are selected for both the <guimenu>Application event container</guimenu> and the <guimenu>Remote destinations</guimenu>, and the application event container is also a source, messages can be duplicated.</para>
            </warning>
            <note>
                <para>These options will be inherited from GPOs (Group Policy Objects). For details, see <xref linkend="windows-inheritance"/>. They can also be exported/imported from an XML configuration also.</para>
            </note>
        </step>
        <step>
            <para>Click <guimenu>Apply</guimenu>.</para>
        </step>
    </procedure>

    <procedure xml:id="windows-global-settings">
        <title>Configuring global settings</title>
        <indexterm>
            <primary>global settings</primary>
        </indexterm>
        <formalpara>
            <title>Purpose:</title>
            <para/>
        </formalpara>
        <para>The &agent; application has some global settings that can apply to both eventlog and file sources. To configure the global settings, complete the following procedure:</para>
        <formalpara>
            <title>Steps:</title>
            <para/>
        </formalpara>
        <step>
            <para>Start the configuration interface of the &agent; application.</para>
        </step>
        <step>
            <para>Select <guimenu>syslog-ng Agent Settings</guimenu> and double-click on <guimenu>Global Settings</guimenu>.</para>
        </step>
        <step>
            <para>Set the default log facility associated to the messages.</para>
        </step>
        <step>
            <para>By default, the filters and regular expressions (see <xref linkend="chapter-filtering"/>) used in the message filters are case-sensitive. To make them case-insensitive, select the <guimenu>Regular Expressions Ignore Case</guimenu> or the <guimenu>Filters Ignore Case</guimenu> options, or both.</para>
            <note>
                <para>The <guimenu>Regular Expressions Ignore Case</guimenu> option makes the <parameter>Message Contents</parameter> filter case-insensitive for both file and eventlog sources. The <guimenu>Filters Ignore Case</guimenu> option makes the <parameter>Computers</parameter>, <parameter>Sources and Categories</parameter>, and the <parameter>Users</parameter> filter case-insensitive.</para>
            </note>
        </step>
        <step>
            <para>Select <guimenu>Apply</guimenu>, then <guimenu>OK</guimenu>. To activate the changes, restart the &agentabbrev; service.</para>
        </step>
    </procedure>

    <procedure xml:id="windows-global-hostname">
        <title>Configuring the hostname format</title>
        <indexterm>
            <primary>hostname</primary>
        </indexterm>
        <indexterm>
            <primary>short hostname</primary>
        </indexterm>
        <indexterm>
            <primary>FQDN</primary>
        </indexterm>
        <indexterm>
            <primary>fully-qualified domain name</primary>
        </indexterm>
        <formalpara>
            <title>Purpose:</title>
            <para/>
        </formalpara>
        <para>The &agent; application can send the hostname macro in different format types (FQDN or short hostname), depending on the domain membership of the host, and the source of the message (eventlog or file). The hostname settings will affect all logs originating from file sources, eventlog sources, as well as MARK messages and internal messages of &agentabbrev;, for example, start/stop messages.</para>
        <para>To prevent using two host licenses from a trusted source, use the same hostname type in every outgoing message.</para>
        <para>To determine the hostname, &agentabbrev; queries the short hostname of the machine at startup, and then attempts to resolve it from the DNS server to receive the FQDN. If DNS resolution is not possible, the hostname will be the short hostname.</para>
        <note>
            <para>The &agentabbrev; will never rewrite hostnames.</para>
        </note>
        <para>To configure the hostname format globally, complete the following steps:</para>
        <formalpara>
            <title>Steps:</title>
            <para/>
        </formalpara>
        <step>
            <para>Select <guimenu>syslog-ng Agent Settings</guimenu> and double-click on <guimenu>Global Settings</guimenu>.</para>
        </step>
        <step>
            <para>Enable <guimenu>Global Settings</guimenu>.</para>
        </step>
        <step>
            <para>Navigate to <guimenu>Hostname</guimenu>.</para>
        </step>
        <step>
            <para>Select the hostname type to use globally.</para>
            <itemizedlist>
                <listitem>
                    <para>To use only the short hostname in the <parameter>$HOST</parameter> macro of the outgoing message, select <guimenu>Use only hostname</guimenu>. This is the default setting.</para>
                    <itemizedlist>
                        <listitem>
                            <para>In case of file sources, MARK messages and internal messages of &agentabbrev; the outgoing hostname will be the short hostname of the machine.</para>
                        </listitem>
                        <listitem>
                            <para>In case of eventlog sources, the hostname will be the short hostname of the event message (for example <parameter>mypc</parameter>), or &agentabbrev; will cut the domain name from the FQDN and use the short hostname part (for example <parameter>mypc.mycompany.local</parameter> becomes <parameter>mypc</parameter>).</para>
                        </listitem>
                    </itemizedlist>
                </listitem>
                <listitem>
                    <para>To use FQDN (<parameter>hostname.domain_name</parameter>) in the <parameter>$HOST</parameter> macro of the outgoing message, select <guimenu>Use FQDN</guimenu>.</para>
                    <itemizedlist>
                        <listitem>
                            <para>In case of file sources, MARK messages and internal messages of &agentabbrev;, the hostname will be the FQDN of the machine.</para>
                            <note>
                                <para>If there is no DNS server, or the DNS server cannot resolve the hostname, only the simple hostname of the machine will be used.</para>
                            </note>
                        </listitem>
                        <listitem>
                            <para>In case of eventlog sources, if the hostname of event message is already an FQDN, &agentabbrev; will use it as the hostname (for example <parameter>mypc.mycompany.local</parameter> will be used as such). If this is not an FQDN, &agentabbrev; will try to resolve this hostname and use the received FQDN as hostname (for example <parameter>mypc</parameter> becomes <parameter>mypc.mycompany.local</parameter>).</para>
                            <note>
                                <para>If there is no DNS server, or the DNS server cannot resolve the hostname, only the short hostname of the event message will be used.</para>
                            </note>
                        </listitem>
                    </itemizedlist>
                </listitem>
                <listitem>
                    <para>To use a custom domain name that will be appended after the short hostname to receive the FQDN, select <guimenu>Use hostname with custom domain name</guimenu> and enter the domain name to append to the short hostname in the field below. This option affects every outgoing message: eventlog sources, file sources, MARK messages and internal messages of &agentabbrev;.</para>
                    <itemizedlist>
                        <listitem>
                            <para>If the hostname is a short hostname, the custom domain name will be appended after the hostname (for example <parameter>mypc</parameter> becomes <parameter>mypc.customcompany.local</parameter>).</para>
                        </listitem>
                        <listitem>
                            <para>If the hostname is an FQDN, the domain name part will be replaced with the custom domain name (for example if the FQDN in the forwarded message is <parameter>mypc.mycompany.local</parameter> and the custom domain name is <parameter>customcompany.local</parameter>, the hostname in the outgoing message becomes <parameter>mypc.customcompany.local</parameter>).</para>
                        </listitem>
                    </itemizedlist>
                </listitem>
            </itemizedlist>
            <note>
                <para>The hostname still can be different in the outgoing messages if in the eventlog message, the hostname in the event is different from the machine hostname:</para>
                <itemizedlist>
                    <listitem>
                        <para>In case of a forwarded eventlog: the original machine hostname will be the hostname.</para>
                    </listitem>
                    <listitem>
                        <para>The machine hostname is different from what the DNS server provides (if there is a DNS server and it can resolve the hostname).</para>
                    </listitem>
                </itemizedlist>
            </note>
        </step>
        <step>
            <para>To use lower-case characters in every hostname, enable <guimenu>Convert to lower-case</guimenu>. This is enabled by default. When disabled, mixed lower-case and upper-case characters (if there is any) will be used in hostnames. This option affects every outgoing message: eventlog sources, file sources, MARK messages and internal messages of &agentabbrev;.</para>
        </step>
        <step>
            <para>Click <guimenu>Apply</guimenu>.</para>
        </step>
    </procedure>

    <procedure xml:id="windows-disable-source">
        <title>Disabling sources and filters globally</title>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>disabling sources and filters</secondary>
        </indexterm>
        <formalpara>
            <title>Purpose:</title>
            <para/>
        </formalpara>
        <para>Filters and sources can be disabled globally as well. Disabling filters or sources means that the &agentabbrev; ignores the disabled settings: that is, if the file sources are disabled, the agent does not send the messages from the files to the server. For details, see the following procedure.</para>
        <formalpara>
            <title>Steps:</title>
            <para/>
        </formalpara>
        <step>
            <para>Start the configuration interface of the &agent; application.</para>
        </step>
        <step>
            <itemizedlist>
                <listitem>
                    <para>To disable eventlog sources, select <guimenu>syslog-ng Agent Settings</guimenu>, right-click on <guimenu>Eventlog Sources</guimenu>, then select <guimenu>Properties > Disable</guimenu>.</para>
                </listitem>
                <listitem>
                    <para>To disable file sources, select <guimenu>syslog-ng Agent Settings</guimenu>, right-click on <guimenu>File Sources</guimenu>, then select <guimenu>Properties > Disable</guimenu>.</para>
                </listitem>
                <listitem>
                    <para>To disable eventlog filters, select <guimenu>syslog-ng Agent Settings > Destinations</guimenu>, right-click on <guimenu>Global Event Filters</guimenu>, then select <guimenu>Properties > Disable</guimenu>.</para>
                </listitem>
                <listitem>
                    <para>To disable file filters, select <guimenu>syslog-ng Agent Settings > Destinations</guimenu>, right-click on <guimenu>Global File Filters</guimenu>, then select <guimenu>Properties > Disable</guimenu>.</para>
                </listitem>
            </itemizedlist>
        </step>
        <step>
            <para>Select <guimenu>Apply</guimenu>, then <guimenu>OK</guimenu>. To activate the changes, restart the &agentabbrev; service.</para>
        </step>
    </procedure>
</chapter>
