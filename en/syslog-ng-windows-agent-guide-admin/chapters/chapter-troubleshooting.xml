<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
<!ENTITY % entities SYSTEM "../../common/syslog-ng-entities.ent">
  %entities;]>
<chapter xml:id="chapter-windows-troubleshooting" xmlns="http://docbook.org/ns/docbook" version="5.0">
    <title>Troubleshooting &agent;</title>
<!--FIXME beindexelni az egyes bejegyzeseket -->
    <indexterm>
        <primary>&agentabbrev;</primary>
        <secondary>troubleshooting</secondary>
    </indexterm>
    <indexterm>
        <primary>troubleshooting</primary>
        <secondary>&agentabbrev;</secondary>
    </indexterm>
    <para>In case you experience problems with the &agent; application, the following points can be of help.</para>
    <note>
        <para>The followings address only problems specific to the &agentabbrev;, and assume that communication between the server and the client is otherwise possible (that is, the server is properly configured to receive messages and is available on the network, and name resolution is properly configured on the client).</para>
    </note>
    <itemizedlist>
        <listitem>
            <para><emphasis>Configuration changes do not take effect</emphasis>: Configuration changes take effect only after restarting the syslog-ng service or rebooting the system. Also restart the system after changing the timezone settings of the host, or importing a certificate that you want to use to authenticate the communication between the agent and the server. If the configuration of the agent has changed since the last restart, the &agentabbrev; sends a message of the change, including the hmac-sha-1 hash of the new configuration.</para>
            <para>Also note that if your clients are managed from a Domain Controller, configuration changes are not instantly downloaded to the client hosts, only at the time of the next group policy update. To update the configuration of a client host earlier, open a command prompt on the client host, and issue the <command>gpupdate /force</command> command.</para>
            <para>After downloading the configuration from the Domain Controller, the syslog-ng Agent service is automatically restarted if the configuration has changed.</para>
            <note>
                <para>Certain domain settings that can affect the &agentabbrev; are downloaded only when the machine is rebooted. For example, moving the computer from one group policy to another requires a reboot to have effect.</para>
            </note>
        </listitem>
        <listitem>
            <para><emphasis>The &agentabbrev; does not send messages to the server</emphasis>: Check the Application eventlog for messages of the &agentabbrev;. In case of connection errors and certificate problems, the &agentabbrev; sends error messages into the eventlog. Ensure that the destination address of the server is correctly set. If you use SSL encryption, verify that the certificate of the Certificate Authority of the server and that the certificate of the client are properly imported. If there are no error messages, check the logs on your log server: the &agentabbrev; sends a MARK message every ten minutes even if there are no other messages to send (unless you have disabled MARK messages).</para>
        </listitem>
        <listitem>
            <para><emphasis>The &agentabbrev; sends only MARK messages to the server</emphasis>: Verify that you have configured the eventlog and file sources, and that they have not been disabled globally. If these settings are correct but the server still does not send any messages, temporarily disable all filters to see that they are not configured to ignore every message. When using filter, it is also recommended to check the global case-sensitivity settings.</para>
        </listitem>
        <listitem>
            <para><emphasis>The hostname used in the messages changes</emphasis>: If a host is sometimes logged in into a domain and sometimes it is not, its hostname might reflect this. To avoid this situation, select<guimenu>syslog-ng Agent Settings</guimenu>and double-click on<guimenu>Global Settings</guimenu>. Enable<guimenu>Global Settings</guimenu>, navigate to<guimenu>Hostname</guimenu>and select<guimenu>Use FQDN</guimenu>. This causes &agentabbrev; to resolve its own hostname from DNS and use the resolved FQDN in the syslog messages. For details, see <xref linkend="windows-global-hostname"/>.</para>
        </listitem>
        <listitem>
            <para><emphasis>Command-line parameters are ignored on Windows Vista and 2008 Server</emphasis>: Command-line parameters work only for administrators if User Account Control (UAC) is enabled. To execute &agentabbrev; with command-line parameters, select<guimenu>Start > Programs > Accessories</guimenu>, right-click on<guimenu>Command prompt > Run as administrator</guimenu>.</para>
            <para>If you contact the BalaBit Support Team about a problem with the syslog-ng Agent for Windows, execute the <command>syslog-ng-agent -V</command> command from the command line and include every version and platform information it displays in your support request.</para>
        </listitem>
        <listitem>
            <para><emphasis>CPU load is high</emphasis>: See <xref linkend="windows-cpu"/>.</para>
        </listitem>
        <listitem>
            <indexterm>
                <primary>losing messages</primary>
                <secondary>from eventlog containers</secondary>
            </indexterm>
            <para><emphasis>Losing messages from eventlog containers</emphasis>: An eventlog container is a special file. The Agent reads this file, formats the messages and sends them to remote log server. Note that the eventlog container can be configured only to a certain size. If the container reaches that size, Windows writes the next message to the beginning of the file. As a result, if the agent is not running (or the destination server is unavailable) so long that the eventlog container is filled up, messages can be lost.</para>
        </listitem>
    </itemizedlist>
    <section xml:id="windows-cpu">
        <title>Sending messages and CPU load</title>
        <para>The &agentabbrev; application can send messages to the server when the Windows Scheduler provides resources to the &agentabbrev;. When there are many unsent log messages in the log sources, and there is no other significant activity on the host, syslog-ng will start to send the messages to the server, possibly increasing the CPU load to 100%. After all messages have been sent, or if another application requires the resources, the CPU load decreases back to normal.</para>
        <tip>
            <para>To avoid the initial large load on the CPU, limit the rate of message sending temporarily. You can remove the limit after the old messages have been sent. For details, see <xref linkend="windows-rate-limit"/>.</para>
        </tip>
        <para>When relaying the messages from multiple sources, the &agentabbrev; sends one message at a time from each source. That way a single source with a large log traffic does not block other log sources.</para>
    </section>
    <section xml:id="windows-debug-logging">
        <title>Debugging &agentabbrev;</title>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>troubleshooting</secondary>
        </indexterm>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>debugging</secondary>
        </indexterm>
        <indexterm>
            <primary>debugging</primary>
        </indexterm>
        <indexterm>
            <primary>debug log</primary>
        </indexterm>
        <para>To enable debug options, create the <filename>debug.ini</filename> file in the &agentabbrev; install directory.</para>
        <example xml:id="example-windows-agent-debug-ini">
            <title>Content of the debug.ini file</title>
            <para>The <filename>debug.ini</filename> can consist of the following entries:</para>
            <synopsis>[AgentDbgLog]
enabled=on/off
path=&lt;debug_file_folder_path&gt;

[GpoDbgLog]
enabled=on/off
path=&lt;debug_file_folder_path&gt;

[WriteMiniDump]
enabled=on/off</synopsis>
        </example>
        <note>
            <para>The <filename>debug.ini</filename> file cannot be distributed. It can only be used on a local machine.</para>
        </note>
        <procedure xml:id="windows-core-dumps">
            <title>Creating core and memory dumps</title>
            <indexterm>
                <primary>&agentabbrev;</primary>
                <secondary>troubleshooting</secondary>
            </indexterm>
            <indexterm>
                <primary>&agentabbrev;</primary>
                <secondary>creating core dumps</secondary>
            </indexterm>
            <formalpara>
                <title>Purpose:</title>
                <para/>
            </formalpara>
            <para>The BalaBit support team might request you to send them core dumps of the &agentabbrev; to investigate a particular problem. When enabled, the &agent; application creates core dumps automatically when it experiences an unexpected shutdown.</para>
            <formalpara>
                <title>Steps:</title>
                <para/>
            </formalpara>
            <step>
                <para>To enable core dumps, enter the following lines in the <filename>debug.ini</filename> file:</para>
                <synopsis>[WriteMiniDump]
enabled=on</synopsis>
<!-- FIXME mi a default install dir, az elejen az installhoz is! -->
                <para>Core dumps are written into the installation folder of the &agentabbrev; under the <filename>syslog-ng-agent.PID.dmp</filename> filename. The size of a core file is typically about 40-50 MB.</para>
                <note>
                    <para>By default, this option is enabled. Due to disk space limits you can disable it to prevent hard disk becomes full.</para>
                </note>
            </step>
            <step>
                <para>To apply the changes, restart the &agentabbrev; after modifying the <parameter>[WriteMiniDump]</parameter> part of the <filename>debug.ini</filename> file.</para>
            </step>
        </procedure>
        <procedure xml:id="debug-agent">
            <title>Enabling debug logging in &agentabbrev;</title>
            <formalpara>
                <title>Purpose:</title>
                <para/>
            </formalpara>
            <para>In case you experience problems with The &agentabbrev; the BalaBit support team might request you to create debug logs for the application to help troubleshoot the problem. Complete the following steps.</para>
            <note>
                <para>The debug log is not suited to detect the reasons behind why a syslog-ng service could not start. The only way to check a non-starting agent service is to run it manually in debug mode (use the command <command>syslog-ng-agent.exe /D</command>). Make sure that if the <parameter>[AgentDbgLog]</parameter> part of the <filename>debug.ini</filename> file exists, it is set to <parameter>enabled=off</parameter>.</para>
            </note>
            <formalpara>
                <title>Steps:</title>
                <para/>
            </formalpara>
            <step>
                <para>To enable logging debug logs, enter the following lines in the <filename>debug.ini</filename> file:</para>
                <synopsis>[AgentDbgLog]
enabled=on</synopsis>
                <para>Debug messages are written into the installation folder of the &agentabbrev; under the <filename>syslog_ng_agent_dbg.log</filename> filename by default, if no other path is specified. To change the destination folder of the debug log file, enter a path in the path=&lt;debug_file_folder_path&gt; row.</para>
                <xi:include href="../../common/wnt/warning-windows-debug-path.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
            </step>
            <step>
                <para>To apply the changes, restart the &agentabbrev; after modifying the <parameter>[AgentDbgLog]</parameter> part of the <filename>debug.ini</filename> file.</para>
                <para>After the restart, a log message is automatically generated about the start of debug logging mode, with a timestamp and the path of the log file.</para>
                <example>
                    <title>Debug logging enabled log message</title>
                    <synopsis>Apr 16 13:14:02 zts-win015 syslog-ng[252]: syslog-ng Agent debug mode is enabled; output file='.\syslog_ng_agent_dbg.log'</synopsis>
                </example>
            </step>
            <step>
                <para>Reproduce the error. It will be included in the debug log.</para>
            </step>
            <step>
                <para>After solving the problem, disable debug logging, otherwise the log file will grow and might consume the available hard disk space. The log file contains the log messages received and processed by the &agentabbrev; as well.</para>
            </step>
        </procedure>
        <procedure xml:id="debug-domain-update">
            <title>Troubleshooting domain setting problems</title>
            <formalpara>
                <title>Purpose:</title>
                <para/>
            </formalpara>
            <para>If the domain settings are not downloaded to a domain host, the &agentabbrev; (starting from version 3.0.6) can create a log file to debug why the domain settings are not updated on the client. Complete the following steps:</para>
            <formalpara>
                <title>Steps:</title>
                <para/>
            </formalpara>
            <step>
                <para>To enable logging domain update errors, enter the following lines in the <filename>debug.ini</filename> file:</para>
                <synopsis>[GpoDbgLog]
enabled=on</synopsis>
                <para>Debug messages are written into the installation folder of the &agentabbrev; under the <filename>syslog_ng_agent_gpo_dbg.log</filename> filename by default, if no other path is specified. To change the destination folder of the debug log file, enter a path in the path=&lt;debug_file_folder_path&gt; row.</para>
                <xi:include href="../../common/wnt/warning-windows-debug-path.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
            </step>
            <step>
                <para>Select<guimenu>Start > Run > gpupdate</guimenu>to reproduce the error.</para>
            </step>
            <step>
                <para>After solving the problem, disable logging domain update errors, otherwise the log file will grow every time when the domain settings of the client are updated.</para>
            </step>
        </procedure>
    </section>
    <section xml:id="windows-agent-eventlog-api">
        <title>Reading eventlog messages is slow on Windows Vista or newer</title>
        <indexterm>
            <primary>eventlog sources</primary>
            <secondary>performance problems</secondary>
        </indexterm>
        <indexterm>
            <primary>eventlog sources</primary>
            <secondary>using the EVT API on XML-based</secondary>
        </indexterm>
        <para>To read the messages from eventlog containers, the &agent; application uses the native Windows API tools. The Windows Vista and newer platforms use an XML-based eventlog format. The API (called EVTX) that reads the XML-messages from the eventlog container and passes them to &agentabbrev; is inherently slow, severely limiting the performance of &agentabbrev;.</para>
        <para>The API tools that &agentabbrev; uses on the Microsoft Windows XP and 2003 Server platforms is available on the newer platforms as well, and can increase the speed of reading from eventlog containers, up to 500%. However, using this old API (called EVT) has limitations when used with XML-based eventlog containers.</para>
        <xi:include href="../../common/syslog-ng-troubleshoot-eventlog.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
        <procedure xml:id="windows-agent-eventlog-api-enable">
            <title>Enabling the EVT API on Windows Vista or newer</title>
            <indexterm>
                <primary>EVT API</primary>
                <secondary>enabling on Windows Vista or newer</secondary>
            </indexterm>
            <formalpara>
                <title>Purpose:</title>
                <para/>
            </formalpara>
            <para>To use the older, but faster EVT API to handle the eventlog containers (instead of the native EVTX API) on Windows Vista or newer, complete the following steps.</para>
            <formalpara>
                <title>Warnings:</title>
                <para/>
            </formalpara>
            <itemizedlist>
                <listitem>
                    <para>Hazard of data loss! If you change the API, the position of the last read message can be lost, causing the &agentabbrev; application to duplicate or lose messages.</para>
                </listitem>
                <listitem>
                    <para>The EVT API is not fully compatible with the EVTX API. Make sure to read <xref linkend="windows-agent-eventlog-api-limitations"/> before changing your configuration.</para>
                </listitem>
                <listitem>
                    <para>Changing the API affects every eventlog container on the host. It is not possible to use the EVT API only for selected containers.</para>
                </listitem>
            </itemizedlist>
            <formalpara>
                <title>Steps:</title>
                <para/>
            </formalpara>
            <step>
                <para>On Windows Vista and Server 2008, install the following hotfix: KB 961099.</para>
                <para>Note that this hotfix is included in Service Pack 2 of Windows Vista and Server 2008. Windows 7 is not affected by this hotfix.</para>
            </step>
            <step>
                <para>Start the configuration interface of the &agent; application.</para>
            </step>
            <step>
                <para>Select<guimenu>syslog-ng Agent Settings > Eventlog Sources > Eventlog Properties</guimenu>.</para>
            </step>
            <step>
                <para>Select<guimenu>Enable</guimenu>.</para>
            </step>
            <step>
                <para>Select<guimenu>Event API > Event Logging (EVT)</guimenu>.</para>
                <note>
                    <para>By default, the &agent; application uses the native API on every platform: EVT on Windows XP and Server 2003, and EVTX on Windows Vista and newer.</para>
                </note>
            </step>
            <step>
                <para>Select<guimenu>Apply</guimenu>, then<guimenu>OK</guimenu>. To activate the changes, restart the &agentabbrev; service.</para>
                <formalpara>
                    <title>Expected result:</title>
                    <para/>
                </formalpara>
                <para>The &agent; application uses the EVT API to read messages from the eventlog containers, improving the performance.</para>
            </step>
        </procedure>
    </section>
</chapter>
