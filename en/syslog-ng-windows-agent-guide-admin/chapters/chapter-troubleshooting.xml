<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter
[
<!ENTITY % entities SYSTEM "../../shared/syslog-ng-entities.ent">
  %entities;]>
<chapter xml:id="chapter-windows-troubleshooting" xmlns="http://docbook.org/ns/docbook" version="5.0">
    <title>Troubleshooting &agent;</title>
<!--FIXME beindexelni az egyes bejegyzeseket -->
    <indexterm>
        <primary>&agentabbrev;</primary>
        <secondary>troubleshooting</secondary>
    </indexterm>
    <indexterm>
        <primary>troubleshooting</primary>
        <secondary>&agentabbrev;</secondary>
    </indexterm>
    <para>In case you experience problems with the &agent; application, the following points can be of help.</para>
    <note>
        <para>The followings address only problems specific to the &agentabbrev;, and assume that communication between the server and the client is otherwise possible (that is, the server is properly configured to receive messages and is available on the network, and name resolution is properly configured on the client).</para>
    </note>
    <itemizedlist>
        <listitem>
            <para><emphasis>Configuration changes do not take effect</emphasis>: Configuration changes take effect only after restarting the syslog-ng service or rebooting the system. Also restart the system after changing the timezone settings of the host, or importing a certificate that you want to use to authenticate the communication between the agent and the server. If the configuration of the agent has changed since the last restart, the &agentabbrev; sends a message of the change, including the hmac-sha-1 hash of the new configuration.</para>
            <para>Also note that if your clients are managed from a Domain Controller, configuration changes are not instantly downloaded to the client hosts, only at the time of the next group policy update. To update the configuration of a client host earlier, open a command prompt on the client host, and issue the <command>gpupdate /force</command> command.</para>
            <para>After downloading the configuration from the Domain Controller, the syslog-ng Agent service is automatically restarted if the configuration has changed.</para>
            <note>
                <para>Certain domain settings that can affect the &agentabbrev; are downloaded only when the machine is rebooted. For example, moving the computer from one group policy to another requires a reboot to have effect.</para>
            </note>
        </listitem>
        <listitem>
            <para><emphasis>The &agentabbrev; does not send messages to the server</emphasis>: Check the Application eventlog for messages of the &agentabbrev;. In case of connection errors and certificate problems, the &agentabbrev; sends error messages into the eventlog. Ensure that the destination address of the server is correctly set. If you use SSL encryption, verify that the certificate of the Certificate Authority of the server and that the certificate of the client are properly imported. If there are no error messages, check the logs on your log server: the &agentabbrev; sends a MARK message every ten minutes even if there are no other messages to send (unless you have disabled MARK messages).</para>
        </listitem>
        <listitem>
            <para><emphasis>The &agentabbrev; sends only MARK messages to the server</emphasis>: Verify that you have configured the eventlog and file sources, and that they have not been disabled globally. If these settings are correct but the server still does not send any messages, temporarily disable all filters to see that they are not configured to ignore every message. When using filter, it is also recommended to check the global case-sensitivity settings.</para>
        </listitem>
        <listitem>
            <para><emphasis>The hostname used in the messages changes</emphasis>: If a host is sometimes logged in into a domain and sometimes it is not, its hostname might reflect this. To avoid this situation, select <guimenu>syslog-ng Agent Settings</guimenu> and double-click on <guimenu>Global Settings</guimenu>. Enable <guimenu>Global Settings</guimenu>, navigate to <guimenu>Hostname</guimenu> and select <guimenu>Use FQDN</guimenu>. This causes &agentabbrev; to resolve its own hostname from DNS and use the resolved FQDN in the syslog messages. For details, see <xref linkend="windows-global-hostname"/>.</para>
        </listitem>
        <listitem>
            <para><emphasis>Command-line parameters are ignored on Windows Vista and 2008 Server</emphasis>: Command-line parameters work only for administrators if User Account Control (UAC) is enabled. To execute &agentabbrev; with command-line parameters, select <guimenu>Start > Programs > Accessories</guimenu>, right-click on <guimenu>Command prompt > Run as administrator</guimenu>.</para>
            <para>If you contact the BalaBit Support Team about a problem with the syslog-ng Agent for Windows, execute the <command>syslog-ng-agent -V</command> command from the command line and include every version and platform information it displays in your support request.</para>
        </listitem>
        <listitem>
            <para><emphasis>CPU load is high</emphasis>: See <xref linkend="windows-cpu"/>.</para>
        </listitem>
        <listitem>
            <indexterm>
                <primary>losing messages</primary>
                <secondary>from eventlog containers</secondary>
            </indexterm>
            <para><emphasis>Losing messages from eventlog containers</emphasis>: An eventlog container is a special file. The Agent reads this file, formats the messages and sends them to remote log server. Note that the eventlog container can be configured only to a certain size. If the container reaches that size, Windows writes the next message to the beginning of the file. As a result, if the agent is not running (or the destination server is unavailable) so long that the eventlog container is filled up, messages can be lost.</para>
        </listitem>
    </itemizedlist>
    <section xml:id="windows-cpu">
        <title>Sending messages and CPU load</title>
        <para>The &agentabbrev; application can send messages to the server when the Windows Scheduler provides resources to the &agentabbrev;. When there are many unsent log messages in the log sources, and there is no other significant activity on the host, syslog-ng will start to send the messages to the server, possibly increasing the CPU load to 100%. After all messages have been sent, or if another application requires the resources, the CPU load decreases back to normal.</para>
        <tip>
            <para>To avoid the initial large load on the CPU, limit the rate of message sending temporarily. You can remove the limit after the old messages have been sent. For details, see <xref linkend="windows-rate-limit"/>.</para>
        </tip>
        <para>When relaying the messages from multiple sources, the &agentabbrev; sends one message at a time from each source. That way a single source with a large log traffic does not block other log sources.</para>
    </section>
    <section xml:id="windows-debug-logging">
        <title>Debugging &agentabbrev;</title>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>troubleshooting</secondary>
        </indexterm>
        <indexterm>
            <primary>&agentabbrev;</primary>
            <secondary>debugging</secondary>
        </indexterm>
        <indexterm>
            <primary>debugging</primary>
        </indexterm>
        <indexterm>
            <primary>debug log</primary>
        </indexterm>
        <para>To enable debug options, create the <filename>debug.ini</filename> file in the &agentabbrev; install directory.</para>
        <example xml:id="example-windows-agent-debug-ini">
            <title>Content of the debug.ini file</title>
            <para>The <filename>debug.ini</filename> can consist of the following entries:</para>
            <synopsis>[AgentDbgLog]
enabled=on/off
path=&lt;debug_file_folder_path&gt;

[GpoDbgLog]
enabled=on/off
path=&lt;debug_file_folder_path&gt;

[WriteMiniDump]
enabled=on/off</synopsis>
        </example>
        <note>
            <para>The <filename>debug.ini</filename> file cannot be distributed. It can only be used on a local machine.</para>
        </note>
        <xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="windows-core-dumps.xml"/>
        <xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="debug-agent.xml"/>
    </section>
    <section xml:id="windows-agent-eventlog-api">
        <title>Reading eventlog messages is slow on Windows Vista or newer</title>
        <indexterm>
            <primary>eventlog sources</primary>
            <secondary>performance problems</secondary>
        </indexterm>
        <indexterm>
            <primary>eventlog sources</primary>
            <secondary>using the EVT API on XML-based</secondary>
        </indexterm>
        <para>To read the messages from eventlog containers, the &agent; application uses the native Windows API tools. The Windows Vista and newer platforms use an XML-based eventlog format. The API (called EVTX) that reads the XML-messages from the eventlog container and passes them to &agentabbrev; is inherently slow, severely limiting the performance of &agentabbrev;.</para>
        <para>The API tools that &agentabbrev; uses on the Microsoft Windows XP and 2003 Server platforms is available on the newer platforms as well, and can increase the speed of reading from eventlog containers, up to 500%. However, using this old API (called EVT) has limitations when used with XML-based eventlog containers.</para>
        <xi:include href="../../shared/syslog-ng-troubleshoot-eventlog.xml" xmlns:xi="http://www.w3.org/2001/XInclude"/>
        <xi:include xmlns:xi="http://www.w3.org/2001/XInclude" href="windows-agent-eventlog-api-enable.xml"/>
    </section>
</chapter>
